#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

Процедура ЗаполнитьТабличныеЧасти(Объект, СтруктураОтбора) Экспорт 
	
	ДопПараметры = ПолучитьДопПараметры();
	 
	//проверим наличие необходимого отбора
	Если НЕ СтруктураОтбора.Свойство("СуществующийДокумент") Тогда
	
		СтруктураОтбора.Вставить("СуществующийДокумент", Ложь);
	
	КонецЕсли;
	
	ДокументОснование = СтруктураОтбора.Документ; 
	Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитентуОПродажах") Тогда 
		// специфический случай. Отчет окмитенту о продажах: номенклатурный состав
		// самого документа не имеет никакого отношения к заполнению налоговой - в ней должна быть только информация
		// об услуге комиссии
		СтрокаУслуг = Объект.Услуги.Добавить();
		СтрокаУслуг.Дата = СтруктураОтбора.Дата;
		СтрокаУслуг.ДоговорКонтрагента = СтруктураОтбора.ДоговорКонтрагента;
		СтрокаУслуг.РасчетыВозврат = СтруктураОтбора.РасчетыВозврат;
		СтрокаУслуг.Сделка = СтруктураОтбора.Сделка;
		СтрокаУслуг.Документ = ДокументОснование;
		
		СтрокаУслуг.Номенклатура = ДокументОснование.УслугаПоВознаграждению;
		СтрокаУслуг.Содержание 	 = ДокументОснование.УслугаПоВознаграждению.НаименованиеПолное;
		
		СтрокаУслуг.Количество = 1;
		СтрокаУслуг.КоличествоВДокумент = 1;
		
		СтрокаУслуг.Цена 			  = ДокументОснование.Товары.Итог("СуммаВознаграждения");
		СтрокаУслуг.Сумма 			  = СтрокаУслуг.Цена;
		СтрокаУслуг.СуммаВДокумент 	  = СтрокаУслуг.Цена;
		СтрокаУслуг.СуммаБезСкидки	  = СтрокаУслуг.Цена;
		СтрокаУслуг.СуммаБезСкидкиВДокумент = СтрокаУслуг.Цена;
		СтрокаУслуг.СтавкаНДС 		  = ДокументОснование.СтавкаНДСВознаграждения;
		СтрокаУслуг.СуммаНДС 		  = ДокументОснование.Товары.Итог("СуммаНДСВознаграждения");
		СтрокаУслуг.СуммаНДСВДокумент = СтрокаУслуг.СуммаНДС;
		
		Для каждого ДопПараметр Из ДопПараметры Цикл
			СтрокаУслуг[ДопПараметр.Ключ] = ДокументОснование[ДопПараметр.Ключ+"ПоРеализации"];
		КонецЦикла;
		
	Иначе		
		// ИНАГРО++ 
		Если ДокументОснование.Метаданные().Имя ="ДокументСсылка.ИНАГРО_ВедомостьРеализация" И 
			 ЗначениеЗаполнено(СтруктураОтбора.Документ.Номенклатура) Тогда 
			 
			Если СтруктураОтбора.Документ.Номенклатура.Услуга Тогда
				ЗаполнитьТабличнуюЧасть(Объект, "Услуги", СтруктураОтбора);
			Иначе
				ЗаполнитьТабличнуюЧасть(Объект, "Товары", СтруктураОтбора);
			КонецЕсли;
			
		Иначе // код типовой конфигурации
			ЗаполнитьТабличнуюЧасть(Объект, "Товары", 		  СтруктураОтбора);
			ЗаполнитьТабличнуюЧасть(Объект, "Услуги", 		  СтруктураОтбора);
			ЗаполнитьТабличнуюЧасть(Объект, "ВозвратнаяТара", СтруктураОтбора);
			ЗаполнитьТабличнуюЧасть(Объект, "ОС", 			  СтруктураОтбора);
			ЗаполнитьТабличнуюЧасть(Объект, "НМА",			  СтруктураОтбора);
			
		КонецЕсли;
		// ИНАГРО--
		
	КонецЕсли;
	
	ОбновитьИсточникиНоменклатуры(Объект, СтруктураОтбора);
	
КонецПроцедуры

Процедура ОбновитьДоговора(Объект, ПараметрОтборДоговоровКонтрагентов = Неопределено) Экспорт
	
	Если Объект.РежимПоДатам Тогда
	
		ОбновитьДоговораПоДатам(Объект, ПараметрОтборДоговоровКонтрагентов);
		
	Иначе	
		
		// установим в таблицах  дату равной дате заполнения
		СписокТаблиц = Новый Массив();
		СписокТаблиц.Добавить("Договора");
		СписокТаблиц.Добавить("ИсточникиНоменклатуры");
		СписокТаблиц.Добавить("Товары");
		СписокТаблиц.Добавить("ВозвратнаяТара");
		СписокТаблиц.Добавить("Услуги");
		СписокТаблиц.Добавить("ОС");
		СписокТаблиц.Добавить("НМА");
			
		МассивДляЗаполненияДаты = Новый Массив();
			
		Для каждого Таблица Из СписокТаблиц Цикл
			
			ТЧ = Объект[Таблица];
				
			Для Инд = МассивДляЗаполненияДаты.Количество() + 1 По ТЧ.Количество() Цикл
				//Добавим в массив элементы, если его размерность меньше количества строк в таблице
				МассивДляЗаполненияДаты.Добавить(Объект.Дата);
			КонецЦикла; 
			
			Для каждого Строка Из ТЧ Цикл
				Строка.Дата = Объект.Дата;
			КонецЦикла;
			
		КонецЦикла;
		
		ОбновитьДоговораНаДату(Объект, ПараметрОтборДоговоровКонтрагентов);
	
	КонецЕсли;	
	
КонецПроцедуры

Функция СформироватьНалоговыеДокументы(Объект) Экспорт
	
	МассивСозданныхОбъектов = Новый Массив;
	
	ТаблицаДанных = Новый ТаблицаЗначений();
	ТаблицаДанных.Колонки.Добавить("СуществующийДокумент",	Новый ОписаниеТипов("Булево"));
	ТаблицаДанных.Колонки.Добавить("Дата", 					Новый ОписаниеТипов("Дата"));
	ТаблицаДанных.Колонки.Добавить("ДоговорКонтрагента", 	Новый ОписаниеТипов("СправочникСсылка.ДоговорыКонтрагентов"));
	ТаблицаДанных.Колонки.Добавить("Сделка", 				Документы.ТипВсеСсылки());
	ТаблицаДанных.Колонки.Добавить("РасчетыВозврат", 		Новый ОписаниеТипов("ПеречислениеСсылка.РасчетыВозврат"));
	ТаблицаДанных.Колонки.Добавить("ВалютаДокумента", 		Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	ТаблицаДанных.Колонки.Добавить("СуммаВключаетНДС", 		Новый ОписаниеТипов("Булево"));
	ТаблицаДанных.Колонки.Добавить("ДокументОснование",		Новый ОписаниеТипов(ПолучитьДопустимыеТипыДокументов()));
	ТаблицаДанных.Колонки.Добавить("СтруктураДанных", 		Новый ОписаниеТипов("Структура"));
	
	
	// Соберем все необходимые данные для формирвания документов
	СтруктураОтбора = Новый Структура("Дата, СуществующийДокумент, ДоговорКонтрагента, Сделка, РасчетыВозврат, Документ");
	КопияИсточникиНоменклатуры = Объект.ИсточникиНоменклатуры.Выгрузить();
	КопияИсточникиНоменклатуры.Свернуть("СуществующийДокумент, Дата, ДоговорКонтрагента, Сделка, РасчетыВозврат, Документ","");
	Для каждого СтрокаДокументов Из КопияИсточникиНоменклатуры Цикл
		
		Если СтрокаДокументов.СуществующийДокумент  Тогда
			
			//это информация о проведенном налоговом документе
			Продолжить;	
			
		КонецЕсли;
		
		// Обновим структуру отбора
		СтруктураОтбора.Дата			 	= СтрокаДокументов.Дата;
		СтруктураОтбора.СуществующийДокумент= Ложь;
		СтруктураОтбора.ДоговорКонтрагента 	= СтрокаДокументов.ДоговорКонтрагента;
		СтруктураОтбора.Сделка 				= СтрокаДокументов.Сделка;
		СтруктураОтбора.РасчетыВозврат 		= СтрокаДокументов.РасчетыВозврат;
		СтруктураОтбора.Документ			= СтрокаДокументов.Документ;
			
		ПолучитьДанныеДляФормированияНалоговыхДокументов(Объект, ТаблицаДанных, СтруктураОтбора);
			
	КонецЦикла; 
	
	//приступаем собственно к формированию и заполнению налоговых документов
	ТаблицаДанных.Сортировать("Дата,ДоговорКонтрагента,РасчетыВозврат,ВалютаДокумента,СуммаВключаетНДС");
	
	ТекущийДата					= Неопределено;
	ТекущийДоговорКонтрагента	= Неопределено;
	ТекущийСделка				= Неопределено;
	ТекущийРасчетыВозврат		= Неопределено;
	ТекущийВалютаДокумента		= Неопределено;
	ТекущийСуммаВключаетНДС		= Неопределено;
	
	// ставкаНДС <-> ВидОперации
	ВозможныеВидыОпераций= Новый Соответствие();
	// ВидОперации <-> Документ
	НалоговыеДокументы 	 = Новый Соответствие();
	
	фНужныНовыеДокументы = Истина;
	Для каждого СтрокаТаблицыДанных Из ТаблицаДанных Цикл
		
		Если НЕ(  СтрокаТаблицыДанных.Дата			 		= ТекущийДата  
				И СтрокаТаблицыДанных.ДоговорКонтрагента	= ТекущийДоговорКонтрагента
				И СтрокаТаблицыДанных.Сделка				= ТекущийСделка
			    И СтрокаТаблицыДанных.РасчетыВозврат 		= ТекущийРасчетыВозврат
			    И СтрокаТаблицыДанных.ВалютаДокумента 		= ТекущийВалютаДокумента
			    И СтрокаТаблицыДанных.СуммаВключаетНДС 		= ТекущийСуммаВключаетНДС) Тогда
				
			фНужныНовыеДокументы = Истина;
	
			// Запомним новые текущие значения
			ТекущийДата 				= СтрокаТаблицыДанных.Дата;
			ТекущийДоговорКонтрагента 	= СтрокаТаблицыДанных.ДоговорКонтрагента;
			ТекущийСделка			 	= СтрокаТаблицыДанных.Сделка;
			ТекущийРасчетыВозврат 		= СтрокаТаблицыДанных.РасчетыВозврат;
			ТекущийВалютаДокумента 		= СтрокаТаблицыДанных.ВалютаДокумента;
			ТекущийСуммаВключаетНДС 	= СтрокаТаблицыДанных.СуммаВключаетНДС;
			
		ИначеЕсли НЕ  Объект.ФормироватьИтоговыеНакладные 
			      ИЛИ СтрокаТаблицыДанных.РасчетыВозврат = Перечисления.РасчетыВозврат.Возврат Тогда	
			   
		   //Изменился документ основание (либо формруются приложения 2, нужны новые документы)
			фНужныНовыеДокументы = Истина;
			
		Иначе 
			
			// в итоговые налоговые накладные будем заносить данные из очередного документа-основания
			фНужныНовыеДокументы = Ложь;
			
		КонецЕсли;	
		
		Если фНужныНовыеДокументы  Тогда
			//Запишем старые, сформированные документы
			
			ЗаписатьПровестиНапечататьНалоговыеДокументы(Объект, НалоговыеДокументы, МассивСозданныхОбъектов);
			
			// "обнулим" документы
			НалоговыеДокументы.Очистить();
			ПолучитьВозможныеВидыОпераций(ВозможныеВидыОпераций, СтрокаТаблицыДанных.РасчетыВозврат);			
			Для каждого ВидОперации Из ВозможныеВидыОпераций Цикл
				Если СтрокаТаблицыДанных.РасчетыВозврат = Перечисления.РасчетыВозврат.Расчеты Тогда
					НалоговыеДокументы.Вставить(ВидОперации.Значение, Документы.НалоговаяНакладная);
				Иначе
					НалоговыеДокументы.Вставить(ВидОперации.Значение, Документы.Приложение2КНалоговойНакладной);	
			    КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
		СтруктураДанных = СтрокаТаблицыДанных.СтруктураДанных;
		
		ТаблицаВозвратнойТары = Неопределено;
		НужноДобавитьВозвратнуюТару = СтруктураДанных.Свойство("ВозвратнаяТара",ТаблицаВозвратнойТары);
		
		Для каждого СтавкаНДС Из Перечисления.СтавкиНДС Цикл
			
			СтруктураТаблиц = Неопределено;
			Если СтруктураДанных.Свойство(ПолучитьИмяЭлементаПеречисленияСтавкиНДС(СтавкаНДС), СтруктураТаблиц) Тогда
				
				// Имеются таблицы с указанной ставкой НДС
				
				ВидОперации = ВозможныеВидыОпераций.Получить(СтавкаНДС);
				НалоговыйДокумент = НалоговыеДокументы.Получить(ВидОперации);
				Если    ТипЗнч(НалоговыйДокумент) = Тип(Документы.НалоговаяНакладная)
					ИЛИ ТипЗнч(НалоговыйДокумент) = Тип(Документы.Приложение2КНалоговойНакладной) Тогда
					// документ-объект с таким видом операции еще не сформирован
					НалоговыйДокумент = НалоговыйДокумент.СоздатьДокумент();
					
					ЗаполнитьШапкуНалоговогоДокумента(Объект, НалоговыйДокумент, ВидОперации, СтрокаТаблицыДанных);
				КонецЕсли;
				
				Для каждого ТабличнаяЧасть Из СтруктураТаблиц Цикл
					
					ДобавитьСтрокиВТабличнуюЧастьНалоговогоДокумента(Объект, НалоговыйДокумент, ТабличнаяЧасть.Ключ, ТабличнаяЧасть.Значение, СтрокаТаблицыДанных);
				
				КонецЦикла;
				
				// добавим в первый формируемый документ всю возвратную тару
				Если НужноДобавитьВозвратнуюТару Тогда
					ДобавитьСтрокиВТабличнуюЧастьНалоговогоДокумента(Объект, НалоговыйДокумент, "ВозвратнаяТара", ТаблицаВозвратнойТары, СтрокаТаблицыДанных);	
					НужноДобавитьВозвратнуюТару = Ложь;
				КонецЕсли;
					
				НалоговыеДокументы.Вставить(ВозможныеВидыОпераций.Получить(СтавкаНДС), НалоговыйДокумент); 
			КонецЕсли;
		КонецЦикла; 
		
		Если  НужноДобавитьВозвратнуюТару Тогда
			// в налоговый документ должна попасть только тара, табличные части не заполнены
			// Вид операции в документе особого значения не имеет
			
			СтавкаНДСДляТары 	= Перечисления.СтавкиНДС.НДС20; 
			ВидОперацииДляТары  = ВозможныеВидыОпераций.Получить(СтавкаНДСДляТары);
			
			НалоговыйДокумент = НалоговыеДокументы.Получить(ВидОперацииДляТары);
			//гарантинровано документ-объект еще не создан
			НалоговыйДокумент = НалоговыйДокумент.СоздатьДокумент();
	
			ЗаполнитьШапкуНалоговогоДокумента(Объект, НалоговыйДокумент, ВидОперацииДляТары, СтрокаТаблицыДанных);
    		ДобавитьСтрокиВТабличнуюЧастьНалоговогоДокумента(Объект, НалоговыйДокумент, "ВозвратнаяТара", ТаблицаВозвратнойТары, СтрокаТаблицыДанных);
			НалоговыеДокументы.Вставить(ВидОперацииДляТары, НалоговыйДокумент); 
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Запишем последние сформированные документы
	ЗаписатьПровестиНапечататьНалоговыеДокументы(Объект, НалоговыеДокументы, МассивСозданныхОбъектов);
	
	Возврат МассивСозданныхОбъектов;
	
КонецФункции

// Функция проверяет, сумма неподтвержденных налоговых обязательств с учетом аванса не превышает ли
// сумму выбранной в ИсточникахНоменклатуры номенклатуры. При отрицательном результате возвращает таблицу
// содержащую суммы частичных отгрузок в разрезе ставок  и доп. параметров (суммы превышения разносятся по ставкам и доп. параметрам пропорционально)
Функция МожноФормироватьНалоговыеНакладные(Объект, СтуктураОтбораИсточниковНоменклатуры, ТаблицаЧастичнойОтгрузки = Неопределено) Экспорт
	
	ДопПараметры = ПолучитьДопПараметры();
	
	// Пока не будет установлено обратное
	Результат = Истина;
	
	ТаблицаНеподтвержденныхОбязательств = ПолучитьСтруктуруИтоговойТаблицы();
	ТаблицаИтоговПоНоменклатуре 		= ПолучитьСтруктуруИтоговойТаблицы();
	ТаблицаЧастичнойОтгрузки 			= ПолучитьСтруктуруИтоговойТаблицы();
	ТаблицаЧастичнойОтгрузки.Колонки.Добавить("ЧастичнаяОтгрузка", 	Новый ОписаниеТипов("Булево"));
	ТаблицаЧастичнойОтгрузки.Колонки.Добавить("ЗаСчетАванса", 	   	Новый ОписаниеТипов("Булево"));
	// комбинации признаков означают следующее: ЧастичнаяОтгрузка/ЗаСчетАванса
	// Ложь	 /Ложь	 - Номенклатура по ставке/таре/доп.параметрам переносятся в налоговый документ полностью
	// Ложь	 /Истина - Номенклатура по ставке/таре/доп.параметрам НЕ переносятся в налоговый документ 
	// Истина/Истина - Образуется частичная отгрузка на сумму пропорционально распределенного между ставками/доп.параметрам аванса
	// Истина/Ложь   - Образуется частичная отгрузка на указанную сумму
	
	// Занесем в таблицу суммы неподтвержденных налоговых обязательств по каждой ставке и определим сумму
	// аванса, не подтвержденного налоговыми документами: ее можно будет закрыть по произвольной ставке.
	СуммаАванса = 0;
	СуммаАвансаТара = 0;
	СтруктураОбораДоговоров = Новый Структура();
	СтруктураОбораДоговоров.Вставить("Дата", СтуктураОтбораИсточниковНоменклатуры.Дата);	
	СтруктураОбораДоговоров.Вставить("ДоговорКонтрагента", СтуктураОтбораИсточниковНоменклатуры.ДоговорКонтрагента);	
	СтруктураОбораДоговоров.Вставить("РасчетыВозврат", СтуктураОтбораИсточниковНоменклатуры.РасчетыВозврат);	
	СтруктураОбораДоговоров.Вставить("Сделка", СтуктураОтбораИсточниковНоменклатуры.Сделка);	
	ДанныеДоговоров = Объект.Договора.НайтиСтроки(СтруктураОбораДоговоров);
	Для каждого СтрокаДоговоров Из ДанныеДоговоров Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаДоговоров.СтавкаНДС) Тогда
			
			Если СтрокаДоговоров.ЗаТару Тогда
				СуммаАвансаТара = СуммаАвансаТара + СтрокаДоговоров.Сумма;
			Иначе
				СуммаАванса = СуммаАванса + СтрокаДоговоров.Сумма;
			КонецЕсли;
			
		Иначе
			
			СтрокаИтоговойТаблицы = ТаблицаНеподтвержденныхОбязательств.Добавить();
			Для каждого ДопПараметр Из ДопПараметры Цикл
				СтрокаИтоговойТаблицы[ДопПараметр.Ключ] = СтрокаДоговоров[ДопПараметр.Ключ];	
			КонецЦикла;
			СтрокаИтоговойТаблицы.СтавкаНДС 		= СтрокаДоговоров.СтавкаНДС;
			СтрокаИтоговойТаблицы.ЗаТару 			= СтрокаДоговоров.ЗаТару;
			СтрокаИтоговойТаблицы.СуммаВДокумент	= СтрокаДоговоров.Сумма;
			СтрокаИтоговойТаблицы.СуммаНДСВДокумент	= СтрокаДоговоров.СуммаНДС;
			
		КонецЕсли;
		
	КонецЦикла;
	
	КолонкиГруппировок = "СтавкаНДС,ЗаТару";
	Для каждого ДопПараметр Из ДопПараметры Цикл
		КолонкиГруппировок = КолонкиГруппировок +"," + ДопПараметр.Ключ;
	КонецЦикла;
	ТаблицаНеподтвержденныхОбязательств.Свернуть(КолонкиГруппировок, "СуммаВДокумент, СуммаНДСВДокумент");
		
	// Определим суммы по номенклатуре
	ДанныеИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.НайтиСтроки(СтуктураОтбораИсточниковНоменклатуры);
	Для каждого СтрокаИсточниковНоменклатуры Из ДанныеИсточниковНоменклатуры Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаИсточниковНоменклатуры.СтавкаНДС) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаИтоговойТаблицы = ТаблицаИтоговПоНоменклатуре.Добавить();
		Для каждого ДопПараметр Из ДопПараметры Цикл
			СтрокаИтоговойТаблицы[ДопПараметр.Ключ] = СтрокаИсточниковНоменклатуры[ДопПараметр.Ключ];	
		КонецЦикла;
		СтрокаИтоговойТаблицы.СтавкаНДС 		= СтрокаИсточниковНоменклатуры.СтавкаНДС;
		СтрокаИтоговойТаблицы.ЗаТару 			= СтрокаИсточниковНоменклатуры.ЗаТару;
		СтрокаИтоговойТаблицы.СуммаВДокумент	= СтрокаИсточниковНоменклатуры.Сумма;
		СтрокаИтоговойТаблицы.СуммаНДСВДокумент	= СтрокаИсточниковНоменклатуры.СуммаНДС;
		
	КонецЦикла; 
	КолонкиГруппировок = "СтавкаНДС,ЗаТару";
	Для каждого ДопПараметр Из ДопПараметры Цикл
		КолонкиГруппировок = КолонкиГруппировок +"," + ДопПараметр.Ключ;
	КонецЦикла;
	ТаблицаИтоговПоНоменклатуре.Свернуть(КолонкиГруппировок, "СуммаВДокумент, СуммаНДСВДокумент");
	
	ОстатокАванса = СуммаАванса;
	ОстатокАвансаТара = СуммаАвансаТара;
	// пройдемся по таблице итогов по номенклатуре и определим имеются ли частичные отгрузки
	СтруктураОтбора = новый Структура();
	Для каждого СтрокаПоНоменклатуре Из ТаблицаИтоговПоНоменклатуре Цикл
		
		СтруктураОтбора.Вставить("СтавкаНДС", СтрокаПоНоменклатуре.СтавкаНДС);
		СтруктураОтбора.Вставить("ЗаТару", 	  СтрокаПоНоменклатуре.ЗаТару);
		Для каждого ДопПараметр Из ДопПараметры Цикл
			СтруктураОтбора.Вставить(ДопПараметр.Ключ, СтрокаПоНоменклатуре[ДопПараметр.Ключ]);	
		КонецЦикла;

		СтрокиНеподтвержденныхОбязательств = ТаблицаНеподтвержденныхОбязательств.НайтиСтроки(СтруктураОтбора);
		Если СтрокиНеподтвержденныхОбязательств.Количество() = 0 Тогда
			// может попасть в НН за счет аванса
			СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
			Для каждого ДопПараметр Из ДопПараметры Цикл
				СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
			КонецЦикла;
			СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
			СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
			СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаПоНоменклатуре.СуммаВДокумент;
			СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаПоНоменклатуре.СуммаНДСВДокумент;
			СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка   = Истина;
			СтрокаЧастичнойОтгрузки.ЗаСчетАванса		= Истина;
			
			Если СтруктураОтбора.ЗаТару Тогда
				ОстатокАвансаТара = ОстатокАвансаТара - СтрокаПоНоменклатуре.СуммаВДокумент;
			Иначе
				ОстатокАванса = ОстатокАванса - СтрокаПоНоменклатуре.СуммаВДокумент;
			КонецЕсли;

		Иначе
			// строка - единственная
			СтрокаНеподтвержденныхОбязательств = СтрокиНеподтвержденныхОбязательств[0];
			Если СтрокаНеподтвержденныхОбязательств.СуммаВДокумент > СтрокаПоНоменклатуре.СуммаВДокумент Тогда
				// эти данные должны попасть в налоговые документы полностью
				СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
				КонецЦикла;
				СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
				СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
				СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаПоНоменклатуре.СуммаВДокумент;
				СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаПоНоменклатуре.СуммаНДСВДокумент;
				СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка   = Ложь;
				СтрокаЧастичнойОтгрузки.ЗаСчетАванса		= Ложь;				
				
			ИначеЕсли СтрокаНеподтвержденныхОбязательств.СуммаВДокумент < СтрокаПоНоменклатуре.СуммаВДокумент Тогда
				// на сумму неподтвержденных обязательств возникает частичная отгрузка, остальное может попасть
				// в налоговый документ за счет аванса
				СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
				КонецЦикла;
				СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
				СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
				СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаНеподтвержденныхОбязательств.СуммаВДокумент;
				СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаНеподтвержденныхОбязательств.СуммаНДСВДокумент;
				СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка   = Истина;
				СтрокаЧастичнойОтгрузки.ЗаСчетАванса		= Ложь;
					
				СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
				КонецЦикла;				
				СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
				СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
				СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаПоНоменклатуре.СуммаВДокумент - СтрокаНеподтвержденныхОбязательств.СуммаВДокумент;
				СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаПоНоменклатуре.СуммаНДСВДокумент - СтрокаНеподтвержденныхОбязательств.СуммаНДСВДокумент;
				СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка   = Истина;
				СтрокаЧастичнойОтгрузки.ЗаСчетАванса		= Истина;
				Если СтруктураОтбора.ЗаТару Тогда
					ОстатокАвансаТара = ОстатокАвансаТара - (СтрокаПоНоменклатуре.СуммаВДокумент - СтрокаНеподтвержденныхОбязательств.СуммаВДокумент);
				Иначе
					ОстатокАванса = ОстатокАванса - (СтрокаПоНоменклатуре.СуммаВДокумент - СтрокаНеподтвержденныхОбязательств.СуммаВДокумент);
				КонецЕсли;
				
			ИначеЕсли НЕ СтрокаНеподтвержденныхОбязательств.СуммаНДСВДокумент = СтрокаПоНоменклатуре.СуммаНДСВДокумент Тогда
				// ситуация с зависшими копейками по НДС (может возникнуть при частичных оплатах/отгрузках
				Результат = Ложь;
				
				СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
				КонецЦикла;
				СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
				СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
				СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаНеподтвержденныхОбязательств.СуммаВДокумент;
				СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаНеподтвержденныхОбязательств.СуммаНДСВДокумент;
				СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка	= Истина;
				СтрокаЧастичнойОтгрузки.ЗаСчетАванса   		= Ложь;
			Иначе
			    // эти данные должны попасть в налоговые документы полностью
				СтрокаЧастичнойОтгрузки = ТаблицаЧастичнойОтгрузки.Добавить();
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаЧастичнойОтгрузки[ДопПараметр.Ключ] = СтруктураОтбора[ДопПараметр.Ключ];	
				КонецЦикла;				
				СтрокаЧастичнойОтгрузки.СтавкаНДС 			= СтруктураОтбора.СтавкаНДС;
				СтрокаЧастичнойОтгрузки.ЗаТару 				= СтруктураОтбора.ЗаТару;
				СтрокаЧастичнойОтгрузки.СуммаВДокумент 		= СтрокаПоНоменклатуре.СуммаВДокумент;
				СтрокаЧастичнойОтгрузки.СуммаНДСВДокумент 	= СтрокаПоНоменклатуре.СуммаНДСВДокумент;
				СтрокаЧастичнойОтгрузки.ЧастичнаяОтгрузка   = Ложь;
				СтрокаЧастичнойОтгрузки.ЗаСчетАванса		= Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	//удалим строки с нулевыми суммами:
	НульСтроки = ТаблицаЧастичнойОтгрузки.НайтиСтроки(Новый Структура("СуммаВДокумент",0));
	Для каждого НульСтрока Из НульСтроки Цикл
		ТаблицаЧастичнойОтгрузки.удалить(НульСтрока);
	КонецЦикла; 
	
	Если ОстатокАванса < 0 ИЛИ ОстатокАвансаТара < 0 ИЛИ (ТаблицаЧастичнойОтгрузки.Количество() = 0 И ТаблицаИтоговПоНоменклатуре.Количество() > 0) Тогда
		Результат = Ложь;
	Иначе
		// суммы неподтвержденного аванса достаточно для того, чтобы по данным номенклатурного состава документа сформировать налогвые документы по определенным ставкам/доп. параметрам
	КонецЕсли;
		
	Если Результат = Ложь Тогда
		// попытаемся распределить авансы
		СтрокиТары 	 = ТаблицаЧастичнойОтгрузки.НайтиСтроки(Новый Структура("ЧастичнаяОтгрузка, ЗаСчетАванса, ЗаТару", Истина, Истина, Истина));
		СтрокиТоваров= ТаблицаЧастичнойОтгрузки.НайтиСтроки(Новый Структура("ЧастичнаяОтгрузка, ЗаСчетАванса, ЗаТару", Истина, Истина, Ложь));
		
		// За Товары
		Если СуммаАванса = 0 Тогда
			// аванса и не было
			Для каждого Строка Из СтрокиТоваров Цикл
				// Установим признак, означающий, что строки товаров по данной ставке не попадут в налоговую накладную.
				Строка.ЧастичнаяОтгрузка	= Ложь;
			КонецЦикла; 
		Иначе
			СуммаОтгрузокВсего = 0;
			Для каждого Строка Из СтрокиТоваров Цикл
				СуммаОтгрузокВсего = СуммаОтгрузокВсего + Строка.СуммаВДокумент;
			КонецЦикла;
			
			КоэффЧастичнойОтгрузки = ?(СуммаОтгрузокВсего = 0, 0, СуммаАванса / СуммаОтгрузокВсего);
			Если КоэффЧастичнойОтгрузки < 1 Тогда
				ПоследняяСтрока = Неопределено;
				ЗачтеноАванса 	= 0;
				Для каждого Строка Из СтрокиТоваров Цикл
					
					Строка.СуммаВДокумент  = Строка.СуммаВДокумент * КоэффЧастичнойОтгрузки;
					// пропорционально определим НДС (НДС в т. ч. - как в регистре НДС Продаж)
					Строка.СуммаНДСВДокумент =  УчетНДСКлиентСервер.РассчитатьСуммуНДС(Строка.СуммаВДокумент, Истина, УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС));
					
					ЗачтеноАванса 	= ЗачтеноАванса + Строка.СуммаВДокумент;
					ПоследняяСтрока = Строка;
				КонецЦикла;
				Если Не ПоследняяСтрока = Неопределено Тогда
					// ошибки округления отнесем на последнюю строку:
					ПоследняяСтрока.СуммаВДокумент = ПоследняяСтрока.СуммаВДокумент + СуммаАванса - ЗачтеноАванса;
					ПоследняяСтрока.СуммаНДСВДокумент =  УчетНДСКлиентСервер.РассчитатьСуммуНДС(ПоследняяСтрока.СуммаВДокумент, Истина, УчетНДС.ПолучитьСтавкуНДС(ПоследняяСтрока.СтавкаНДС))
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;	
		
		// За Тару
		Если СуммаАвансаТара = 0 Тогда
			Для каждого Строка Из СтрокиТары Цикл
				Строка.ЧастичнаяОтгрузка	= Ложь;
			КонецЦикла; 
		Иначе
			СуммаОтгрузокВсего = 0;
			Для каждого Строка Из СтрокиТары Цикл
				СуммаОтгрузокВсего = СуммаОтгрузокВсего + Строка.СуммаВДокумент;
			КонецЦикла;
			
			КоэффЧастичнойОтгрузки = ?(СуммаОтгрузокВсего = 0, 0, СуммаАвансаТара / СуммаОтгрузокВсего);
			Если КоэффЧастичнойОтгрузки < 1 Тогда
				ПоследняяСтрока = Неопределено;
				ЗачтеноАванса 	= 0;
				Для каждого Строка Из СтрокиТары Цикл
					Строка.СуммаВДокумент  = Строка.СуммаВДокумент * КоэффЧастичнойОтгрузки;
					
					ЗачтеноАванса 	= ЗачтеноАванса + Строка.СуммаВДокумент;
					ПоследняяСтрока = Строка;
				КонецЦикла;
				Если Не ПоследняяСтрока = Неопределено Тогда
					// ошибки округления отнесем на последнюю строку:
					ПоследняяСтрока.СуммаВДокумент = ПоследняяСтрока.СуммаВДокумент + СуммаАвансаТара - ЗачтеноАванса;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция БудутСформированыНалоговыеНакладные(ТаблицаЧастичнойОтгрузки) Экспорт
	
	ТаблицаКопия = ТаблицаЧастичнойОтгрузки.Скопировать();
	
	ТаблицаКопия.Свернуть("ЧастичнаяОтгрузка, ЗаСчетАванса");
	
	Результат = Ложь;
	Для каждого Строка Из ТаблицаКопия Цикл
		
		Если  Строка.ЧастичнаяОтгрузка = Ложь
			И Строка.ЗаСчетАванса	   = Истина Тогда
			Продолжить;
		Иначе
			Результат = Истина;
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
		
	Возврат Результат;
	
КонецФункции

Процедура ПодготовитьНоменклатурныйСоставПриЧастичнойОтгрузке(Объект, СтуктураОтбораНоменклатуры, ТаблицаЧастичнойОтгрузки) Экспорт
	
	ДопПараметры = ПолучитьДопПараметры();
	
	ДанныеДокумента = Новый Структура();
	ДанныеДокумента.Вставить("Дата", 			СтуктураОтбораНоменклатуры.Документ.Дата);
	ДанныеДокумента.Вставить("СуммаВключаетНДС",СтуктураОтбораНоменклатуры.Документ.СуммаВключаетНДС);
	ДанныеДокумента.Вставить("ВалютаДокумента", СтуктураОтбораНоменклатуры.Документ.ВалютаДокумента);
	ДанныеВалютыДокумента = МодульВалютногоУчета.ПолучитьКурсВалюты(ДанныеДокумента.ВалютаДокумента, ДанныеДокумента.Дата); 
	ДанныеДокумента.Вставить("КурсВалютыДокумента", 	ДанныеВалютыДокумента.Курс);
	ДанныеДокумента.Вставить("КратностьВалютыДокумента", 	ДанныеВалютыДокумента.Кратность);
	
	СтруктураОтбораСтрокНоменклатуры = Новый Структура();
    СтруктураОтбораСтрокНоменклатуры.Вставить("Дата", 				СтуктураОтбораНоменклатуры.Дата);
	СтруктураОтбораСтрокНоменклатуры.Вставить("Документ", 			СтуктураОтбораНоменклатуры.Документ);
	СтруктураОтбораСтрокНоменклатуры.Вставить("ДоговорКонтрагента", СтуктураОтбораНоменклатуры.ДоговорКонтрагента);
	СтруктураОтбораСтрокНоменклатуры.Вставить("Сделка", 			СтуктураОтбораНоменклатуры.Сделка);
	СтруктураОтбораСтрокНоменклатуры.Вставить("РасчетыВозврат", 	СтуктураОтбораНоменклатуры.РасчетыВозврат);
	
	// сначала удалим строки номенклатуры, которые или не перенесутся или перенесутся частично
	Для каждого СтрокаТаблицыЧастичнойОтгрузки Из ТаблицаЧастичнойОтгрузки Цикл
		
		Для каждого ДопПараметр Из ДопПараметры Цикл
			СтруктураОтбораСтрокНоменклатуры.Вставить(ДопПараметр.Ключ, СтрокаТаблицыЧастичнойОтгрузки[ДопПараметр.Ключ])	
		КонецЦикла;
		
		Если СтрокаТаблицыЧастичнойОтгрузки.ЗаТару Тогда
			
			Если  (СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка  = Ложь 
				И СтрокаТаблицыЧастичнойОтгрузки.ЗаСчетАванса	     = Истина)
				ИЛИ СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка = Истина Тогда
				// признак того, что строки номенклатуры не переносятся либо заменяются строкой "Частичная отгрузка"
				
				СтрокиТары = Объект.ВозвратнаяТара.НайтиСтроки(СтруктураОтбораСтрокНоменклатуры);
				Для каждого СтрокаТары Из СтрокиТары Цикл
					Объект.ВозвратнаяТара.Удалить(СтрокаТары);
				КонецЦикла; 
				
			КонецЕсли;
			
		Иначе
			
			СтруктураОтбораСтрокНоменклатуры.Вставить("СтавкаНДС", СтрокаТаблицыЧастичнойОтгрузки.СтавкаНДС);

			Если  (СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка  = Ложь 
				И СтрокаТаблицыЧастичнойОтгрузки.ЗаСчетАванса  		 = Истина) 
				ИЛИ СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка = Истина Тогда
				
				// строки номенклатуры или не переносятся вообще, либо заменяются строкой "Частичная отгрузка" в ТЧ Товары
				Строки = Объект.Товары.НайтиСтроки(СтруктураОтбораСтрокНоменклатуры);
				Для каждого Строка Из Строки Цикл
					Объект.Товары.Удалить(Строка);
				КонецЦикла; 
				
				Строки = Объект.Услуги.НайтиСтроки(СтруктураОтбораСтрокНоменклатуры);
				Для каждого Строка Из Строки Цикл
					Объект.Услуги.Удалить(Строка);
				КонецЦикла; 
				
				Строки = Объект.ОС.НайтиСтроки(СтруктураОтбораСтрокНоменклатуры);
				Для каждого Строка Из Строки Цикл
					Объект.ОС.Удалить(Строка);
				КонецЦикла; 
				
				Строки = Объект.НМА.НайтиСтроки(СтруктураОтбораСтрокНоменклатуры);
				Для каждого Строка Из Строки Цикл
					Объект.НМА.Удалить(Строка);
				КонецЦикла; 
				
			КонецЕсли;
						
		КонецЕсли;
	
	КонецЦикла; 
	
	// Теперь добавим строки "Частичная отгрузка"
	Для каждого СтрокаТаблицыЧастичнойОтгрузки Из ТаблицаЧастичнойОтгрузки Цикл
		
		Если СтрокаТаблицыЧастичнойОтгрузки.ЗаТару Тогда
			
			Если  СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка = Истина Тогда 
				
				СтрокаТары = Объект.ВозвратнаяТара.Добавить();
				СтрокаТары.Дата				 	= СтруктураОтбораСтрокНоменклатуры.Дата;
				СтрокаТары.ДоговорКонтрагента 	= СтруктураОтбораСтрокНоменклатуры.ДоговорКонтрагента;
				СтрокаТары.Сделка 				= СтруктураОтбораСтрокНоменклатуры.Сделка;
				СтрокаТары.РасчетыВозврат		= СтруктураОтбораСтрокНоменклатуры.РасчетыВозврат;
				СтрокаТары.Документ 			= СтруктураОтбораСтрокНоменклатуры.Документ;
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаТары[ДопПараметр.Ключ] = СтрокаТаблицыЧастичнойОтгрузки[ДопПараметр.Ключ];	
				КонецЦикла;
				
				СтрокаТары.Номенклатура			= Справочники.Номенклатура.ПустаяСсылка();
				СтрокаТары.КоличествоВДокумент 	= 1;
				СтрокаТары.СуммаВДокумент = СтрокаТаблицыЧастичнойОтгрузки.СуммаВДокумент;
				
			КонецЕсли;
			
		Иначе
			
			Если  СтрокаТаблицыЧастичнойОтгрузки.ЧастичнаяОтгрузка = Истина Тогда 
				
				// Добавим строку в ТЧ "Товары" номенклатурой "по-умолчанию" для заполнения налоговых накладных
				СтрокаТовары = Объект.Товары.Добавить();
				СтрокаТовары.Дата				= СтруктураОтбораСтрокНоменклатуры.Дата;
				СтрокаТовары.ДоговорКонтрагента = СтруктураОтбораСтрокНоменклатуры.ДоговорКонтрагента;
				СтрокаТовары.Сделка 			= СтруктураОтбораСтрокНоменклатуры.Сделка;
				СтрокаТовары.РасчетыВозврат		= СтруктураОтбораСтрокНоменклатуры.РасчетыВозврат;
				СтрокаТовары.Документ 			= СтруктураОтбораСтрокНоменклатуры.Документ;
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтрокаТовары[ДопПараметр.Ключ] = СтрокаТаблицыЧастичнойОтгрузки[ДопПараметр.Ключ];	
				КонецЦикла;
				СтрокаТовары.Номенклатура 		= БухгалтерскийУчетПереопределяемый.ПолучитьЗначениеПоУмолчанию("НоменклатураДляЗаполненияНалоговыхНакладных");
				СтрокаТовары.КоличествоВДокумент= 1;
				СтрокаТовары.ЕдиницаИзмерения 	= СтрокаТовары.Номенклатура.БазоваяЕдиницаИзмерения;
				СтрокаТовары.Коэффициент	 	= 1;
				СтрокаТовары.СтавкаНДС 			= СтрокаТаблицыЧастичнойОтгрузки.СтавкаНДС;
				
				// Сумма в таблице частичной отгрузки в гривнах и включает НДС. Нужно пересчитать суммы
				СуммаВДокумент = ?(ДанныеДокумента.СуммаВключаетНДС,
								   СтрокаТаблицыЧастичнойОтгрузки.СуммаВДокумент, 
								   СтрокаТаблицыЧастичнойОтгрузки.СуммаВДокумент - СтрокаТаблицыЧастичнойОтгрузки.СуммаНДСВДокумент);
								   
				ВалютаВзаиморасчетовНУ  = СтруктураОтбораСтрокНоменклатуры.ДоговорКонтрагента.ВалютаВзаиморасчетов;
				ДанныеВалютыВзаимНУ     = МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаВзаиморасчетовНУ, ДанныеДокумента.Дата); 
								   
				Если ДанныеДокумента.ВалютаДокумента = ДанныеВалютыВзаимНУ Тогда
					СтрокаТовары.Цена 				= СуммаВДокумент;
					СтрокаТовары.СуммаВДокумент	 	= СуммаВДокумент;
					СтрокаТовары.СуммаБезСкидкиВДокумент = СуммаВДокумент;
					СтрокаТовары.СуммаНДСВДокумент 	= СтрокаТаблицыЧастичнойОтгрузки.СуммаНДСВДокумент;
				Иначе
					СтрокаТовары.СуммаВДокумент = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(СуммаВДокумент,
														  ВалютаВзаиморасчетовНУ, 			ДанныеДокумента.ВалютаДокумента,
														  ДанныеВалютыВзаимНУ.Курс, 		ДанныеДокумента.КурсВалютыДокумента, 		
														  ДанныеВалютыВзаимНУ.Кратность,	ДанныеДокумента.КратностьВалютыДокумента);
														  
					СтрокаТовары.Цена 					 = СтрокаТовары.СуммаВДокумент;
					СтрокаТовары.СуммаБезСкидкиВДокумент = СтрокаТовары.СуммаВДокумент;
					
					СтрокаТовары.СуммаНДСВДокумент = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(СтрокаТаблицыЧастичнойОтгрузки.СуммаНДСВДокумент,
														  ВалютаВзаиморасчетовНУ, 			ДанныеДокумента.ВалютаДокумента,
														  ДанныеВалютыВзаимНУ.Курс, 		ДанныеДокумента.КурсВалютыДокумента, 		
														  ДанныеВалютыВзаимНУ.Кратность,	ДанныеДокумента.КратностьВалютыДокумента);
																		  
														  
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
	
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбновитьДоговораНаДату(Объект, ПараметрОтборДоговоровКонтрагентов)
	
	ДопПараметры = ПолучитьДопПараметры();
	
	Запрос = Новый Запрос();
	
	Запрос.УстановитьПараметр("Отгрузка", 		Перечисления.РасчетыВозврат.Расчеты);
	Запрос.УстановитьПараметр("Возврат", 		Перечисления.РасчетыВозврат.Возврат);
	
	СобытияПродажиНалоговыйУчетРасчеты = Новый СписокЗначений();
	СобытияПродажиНалоговыйУчетРасчеты.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.РеализацияПокупателю);
	СобытияПродажиНалоговыйУчетРасчеты.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ОплатаПокупателем);
	Запрос.УстановитьПараметр("СобытияПродажиНалоговыйУчетРасчеты", СобытияПродажиНалоговыйУчетРасчеты);
	Запрос.УстановитьПараметр("ПродажиНалоговыйУчетРасчетыОплата", Перечисления.СобытияПродажиНалоговыйУчет.ОплатаПокупателем);
	
	СобытияПродажиНалоговыйУчетВозврат = Новый СписокЗначений();
	СобытияПродажиНалоговыйУчетВозврат.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОтПокупателя);
	СобытияПродажиНалоговыйУчетВозврат.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОплатыПокупателю);
	Запрос.УстановитьПараметр("СобытияПродажиНалоговыйУчетВозврат", СобытияПродажиНалоговыйУчетВозврат);
	Запрос.УстановитьПараметр("ПродажиНалоговыйУчетВозвратОплата", Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОплатыПокупателю);
	
	СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка = Новый СписокЗначений();
	СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка.Добавить(Перечисления.СобытияОжидаемыйИПодтвержденныйНДСПродаж.Реализация);
	Запрос.УстановитьПараметр("СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка", СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка);
	
	СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат = Новый СписокЗначений();
	СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат.Добавить(Перечисления.СобытияОжидаемыйИПодтвержденныйНДСПродаж.Возврат);
	Запрос.УстановитьПараметр("СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат", СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат);
	
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Запрос.УстановитьПараметр("ДоговорСКомиссионером", Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером);
	
	ДополнительныеУсловия = "";
	Если Не ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента В (&ДоговораКонтрагентов) И Сделка В (&Сделки) ";
		Запрос.УстановитьПараметр("ДоговораКонтрагентов", ПараметрОтборДоговоровКонтрагентов.ВыгрузитьКолонку("ДоговорКонтрагента"));
		Запрос.УстановитьПараметр("Сделки", ПараметрОтборДоговоровКонтрагентов.ВыгрузитьКолонку("Сделка"));
		
	Иначе
		
		ОтборДоговоров = Объект.ОтборДоговоровКонтрагентов.Выгрузить();
		ОтборДоговоров.Свернуть("ДоговорКонтрагента", "");
		СтрокаСПустымДоговором = ОтборДоговоров.Найти(Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
		Если НЕ СтрокаСПустымДоговором = Неопределено Тогда 
			ОтборДоговоров.Удалить(СтрокаСПустымДоговором);	
		КонецЕсли;
		
		// если остались строки, значит устанавливаем фильтр по договорам,
		// иначе - по контрагентам
		Если ОтборДоговоров.Количество() > 0 Тогда
			
			ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента В (&ДоговораКонтрагентов) ";
			Запрос.УстановитьПараметр("ДоговораКонтрагентов", ОтборДоговоров);
			
		Иначе 
			
			ОтборКонтрагентов = Объект.ОтборДоговоровКонтрагентов.Выгрузить();
			ОтборКонтрагентов.Свернуть("Контрагент", "");
			Если ОтборКонтрагентов.Количество() > 0 Тогда
				ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента.Владелец В ИЕРАРХИИ(&Контрагенты) ";
				Запрос.УстановитьПараметр("Контрагенты", ОтборКонтрагентов);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;		
	
	Если НЕ ЗначениеЗаполнено(Объект.Дата) Тогда
		Запрос.УстановитьПараметр("МоментВремени", 	'000101010000');
	Иначе		
		Запрос.УстановитьПараметр("МоментВремени", 	Новый Граница(Объект.Дата, ВидГраницы.Включая));
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	
	ТекстЗапросаРасчеты=
				  "	&Дата КАК Дата,
				   |    Истина КАК СложныйНалоговыйУчет,
				   |	&Отгрузка КАК РасчетыВозврат,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.ДоговорКонтрагента.Владелец 
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.Владелец 	
				   |	КОНЕЦ КАК Контрагент,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.ДоговорКонтрагента 		  
				   |	ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента 		
				   |	КОНЕЦ КАК ДоговорКонтрагента,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.Сделка ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.Сделка 		  
				   |	ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.Сделка 		
				   |	КОНЕЦ КАК Сделка,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
				   |		ВЫБОР КОГДА ПродажиНалоговыйУчет.ВозвратнаяТара = Истина ТОГДА ПродажиНалоговыйУчет.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ПродажиНалоговыйУчет.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ 
			   	   |	  ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара = Истина ТОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ 
				   |	КОНЕЦ КАК Схема,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
				   |		ПродажиНалоговыйУчет.ВозвратнаяТара 
				   |	 ИНАЧЕ
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара 
				   |	КОНЕЦ КАК ЗаТару,";
				   Для каждого ДопПараметр Из ДопПараметры Цикл
		   		   ТекстЗапросаРасчеты = ТекстЗапросаРасчеты +"
				   |    ОжидаемыйИПодтвержденныйНДСПродаж."+ДопПараметр.Ключ +" КАК " + ДопПараметр.Ключ+",";
				   КонецЦикла; 				   
				   ТекстЗапросаРасчеты = ТекстЗапросаРасчеты +"
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.СтавкаНДС 	  КАК СтавкаНДС,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток < 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток < 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаНДСОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток > 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			-ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаАванс,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток > 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			-ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаНДСАванс,
				   |	ПродажиНалоговыйУчет.Аванс 						  КАК СуммаПревышенияОплатНадОтгрузкой
				   |ИЗ                                                                                                                           
	               |	РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Остатки(&МоментВремени, (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И СобытиеНДС В (&СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка) " + ДополнительныеУсловия + ") КАК ОжидаемыйИПодтвержденныйНДСПродаж
				   |    ПРАВОЕ СОЕДИНЕНИЕ
				   |        (ВЫБРАТЬ 
				   |            ПродажиНалоговыйУчет.ДоговорКонтрагента КАК ДоговорКонтрагента,
				   |            ПродажиНалоговыйУчет.Сделка КАК Сделка,
				   |            ПродажиНалоговыйУчет.ВозвратнаяТара		КАК ВозвратнаяТара,
				   |            СУММА(ВЫБОР КОГДА ПродажиНалоговыйУчет.Событие = &ПродажиНалоговыйУчетРасчетыОплата ТОГДА ПродажиНалоговыйУчет.СуммаВзаиморасчетовОстаток ИНАЧЕ - ПродажиНалоговыйУчет.СуммаВзаиморасчетовОстаток КОНЕЦ) КАК Аванс
				   |                                                                                                                    
				   |         ИЗ РегистрНакопления.ПродажиНалоговыйУчет.Остатки(&МоментВремени, (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И Событие В (&СобытияПродажиНалоговыйУчетРасчеты) " + ДополнительныеУсловия+ ") КАК ПродажиНалоговыйУчет
				   |
				   |		 СГРУППИРОВАТЬ ПО
				   |			ПродажиНалоговыйУчет.ДоговорКонтрагента,
				   |			ПродажиНалоговыйУчет.Сделка,
				   |			ПродажиНалоговыйУчет.ВозвратнаяТара) КАК ПродажиНалоговыйУчет
				   |    ПО 
				   |       ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента 	= ПродажиНалоговыйУчет.ДоговорКонтрагента
				   |     И ОжидаемыйИПодтвержденныйНДСПродаж.Сделка 				= ПродажиНалоговыйУчет.Сделка
				   |     И ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара 		= ПродажиНалоговыйУчет.ВозвратнаяТара
				   |
				   |ОБЪЕДИНИТЬ ВСЕ
				   |
		  		   |ВЫБРАТЬ
				   |	&Дата КАК Дата,
				   |    ЛОЖЬ КАК СложныйНалоговыйУчет,
				   |	&Отгрузка КАК РасчетыВозврат,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.Владелец КАК Контрагент,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента  КАК ДоговорКонтрагента,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.Сделка КАК Сделка,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара = Истина ТОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ КАК Схема,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара КАК ЗаТару,";
				   Для каждого ДопПараметр Из ДопПараметры Цикл
		   		   ТекстЗапросаРасчеты = ТекстЗапросаРасчеты +"
				   |    ОжидаемыйИПодтвержденныйНДСПродаж."+ДопПараметр.Ключ +" КАК " + ДопПараметр.Ключ+",";
				   КонецЦикла; 				   
				   ТекстЗапросаРасчеты = ТекстЗапросаРасчеты +"
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.СтавкаНДС 	  КАК СтавкаНДС,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток < 0 ТОГДА
				   |		0
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |	КОНЕЦ КАК СуммаОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток < 0 ТОГДА
				   |		0
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |	КОНЕЦ КАК СуммаНДСОтгрузки,
				   |	0 КАК СуммаАванс,
				   |	0 КАК СуммаНДСАванс,
				   |	0 КАК СуммаПревышенияОплатНадОтгрузкой
				   |ИЗ                                                                                                                           
	               |	РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Остатки(&МоментВремени, (НЕ ДоговорКонтрагента.СложныйНалоговыйУчет  ИЛИ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И СобытиеНДС В (&СобытияОжидаемыйИПодтвержденныйНДСПродажОтгрузка) " + ДополнительныеУсловия + ") КАК ОжидаемыйИПодтвержденныйНДСПродаж
				   |";
				   
   ТекстЗапросаВозврат=
				  "	&Дата КАК Дата,
				   |    Истина КАК СложныйНалоговыйУчет,
				   |	&Возврат КАК РасчетыВозврат,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.ДоговорКонтрагента.Владелец 
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.Владелец 	
				   |	КОНЕЦ КАК Контрагент,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.ДоговорКонтрагента 		  
				   |	ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента 		
				   |	КОНЕЦ КАК ДоговорКонтрагента,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.Сделка ЕСТЬ NULL ТОГДА 
			   	   |		ПродажиНалоговыйУчет.Сделка 		  
				   |	ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.Сделка 		
				   |	КОНЕЦ КАК Сделка,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
				   |		ВЫБОР КОГДА ПродажиНалоговыйУчет.ВозвратнаяТара = Истина ТОГДА ПродажиНалоговыйУчет.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ПродажиНалоговыйУчет.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ 
			   	   |	  ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара = Истина ТОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ 
				   |	КОНЕЦ КАК Схема,
	               |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента ЕСТЬ NULL ТОГДА 
				   |		ПродажиНалоговыйУчет.ВозвратнаяТара 
				   |	 ИНАЧЕ
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара 
				   |	КОНЕЦ КАК ЗаТару,";
				   Для каждого ДопПараметр Из ДопПараметры Цикл
		   		   ТекстЗапросаВозврат = ТекстЗапросаВозврат +"
				   |    ОжидаемыйИПодтвержденныйНДСПродаж."+ДопПараметр.Ключ +" КАК " + ДопПараметр.Ключ+",";
				   КонецЦикла; 				   
				   ТекстЗапросаВозврат = ТекстЗапросаВозврат +"
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.СтавкаНДС 	  КАК СтавкаНДС,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток < 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток < 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаНДСОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток > 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			-ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаАванс,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток ЕСТЬ NULL ТОГДА
				   |		0
				   |	 ИНАЧЕ
				   |		ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток > 0 ТОГДА
				   |			0
				   |		 ИНАЧЕ 
				   |			-ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |		КОНЕЦ
				   |	КОНЕЦ КАК СуммаНДСАванс,
	               |	ПродажиНалоговыйУчет.Аванс 						  КАК СуммаПревышенияОплатНадОтгрузкой
				   |ИЗ                                                                                                                       
	               |	РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Остатки(&МоментВремени, (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И СобытиеНДС В (&СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат) " + ДополнительныеУсловия + ") КАК ОжидаемыйИПодтвержденныйНДСПродаж
				   |    ПРАВОЕ СОЕДИНЕНИЕ
				   |        (ВЫБРАТЬ 
				   |            ПродажиНалоговыйУчет.ДоговорКонтрагента КАК ДоговорКонтрагента,
				   |            ПродажиНалоговыйУчет.Сделка КАК Сделка,
				   |            ПродажиНалоговыйУчет.ВозвратнаяТара		КАК ВозвратнаяТара,
				   |            СУММА(ВЫБОР КОГДА ПродажиНалоговыйУчет.Событие = &ПродажиНалоговыйУчетВозвратОплата ТОГДА ПродажиНалоговыйУчет.СуммаВзаиморасчетовОстаток ИНАЧЕ - ПродажиНалоговыйУчет.СуммаВзаиморасчетовОстаток КОНЕЦ) КАК Аванс
				   |                                                                                                                    
				   |         ИЗ РегистрНакопления.ПродажиНалоговыйУчет.Остатки(&МоментВремени, (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И Событие В (&СобытияПродажиНалоговыйУчетВозврат) " + ДополнительныеУсловия+ ") КАК ПродажиНалоговыйУчет
				   |
				   |		 СГРУППИРОВАТЬ ПО
				   |			ПродажиНалоговыйУчет.ДоговорКонтрагента,
				   |			ПродажиНалоговыйУчет.Сделка,
				   |			ПродажиНалоговыйУчет.ВозвратнаяТара) КАК ПродажиНалоговыйУчет
				   |    ПО 
				   |       ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента 	= ПродажиНалоговыйУчет.ДоговорКонтрагента
				   |     И ОжидаемыйИПодтвержденныйНДСПродаж.Сделка 				= ПродажиНалоговыйУчет.Сделка
				   |     И ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара 		= ПродажиНалоговыйУчет.ВозвратнаяТара
				   |
				   |ОБЪЕДИНИТЬ ВСЕ
				   |
		  		   |ВЫБРАТЬ
				   |	&Дата КАК Дата,
				   |    Ложь КАК СложныйНалоговыйУчет,				   
				   |	&Возврат КАК РасчетыВозврат,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.Владелец КАК Контрагент,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.Сделка КАК Сделка,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара = Истина ТОГДА ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам ИНАЧЕ ОжидаемыйИПодтвержденныйНДСПродаж.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам КОНЕЦ КАК Схема,
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.ВозвратнаяТара КАК ЗаТару,";
				   Для каждого ДопПараметр Из ДопПараметры Цикл
		   		   ТекстЗапросаВозврат = ТекстЗапросаВозврат +"
				   |    ОжидаемыйИПодтвержденныйНДСПродаж."+ДопПараметр.Ключ +" КАК " + ДопПараметр.Ключ+",";
				   КонецЦикла; 				   
				   ТекстЗапросаВозврат = ТекстЗапросаВозврат +"
	               |	ОжидаемыйИПодтвержденныйНДСПродаж.СтавкаНДС 	  КАК СтавкаНДС,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток < 0 ТОГДА
				   |		0
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.БазаНДСОстаток
				   |	КОНЕЦ КАК СуммаОтгрузки,
				   |	ВЫБОР КОГДА ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток < 0 ТОГДА
				   |		0
				   |	 ИНАЧЕ 
				   |		ОжидаемыйИПодтвержденныйНДСПродаж.СуммаНДСОстаток
				   |	КОНЕЦ КАК СуммаНДСОтгрузки,
				   |	0 КАК СуммаАванс,
				   |	0 КАК СуммаНДСАванс,
	               |	0 КАК СуммаПревышенияОплатНадОтгрузкой
				   |ИЗ
	               |	РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Остатки(&МоментВремени, (НЕ ДоговорКонтрагента.СложныйНалоговыйУчет ИЛИ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) И Организация = &Организация И СобытиеНДС В (&СобытияОжидаемыйИПодтвержденныйНДСПродажВозврат) " + ДополнительныеУсловия + ") КАК ОжидаемыйИПодтвержденныйНДСПродаж
				   |";
	
	Если  НЕ ЗначениеЗаполнено(Объект.РасчетыВозврат) = Ложь
		И ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		Если Объект.РасчетыВозврат = Перечисления.РасчетыВозврат.Расчеты Тогда
			Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
							|" +ТекстЗапросаРасчеты;	
		Иначе
			Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
							|" +ТекстЗапросаВозврат;	
		КонецЕсли; 
		
	Иначе
		Запрос.Текст = 	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
						|" + ТекстЗапросаРасчеты + "
						| ОБЪЕДИНИТЬ ВСЕ
						|
						|ВЫБРАТЬ
						|" + ТекстЗапросаВозврат;
	КонецЕсли;
					
	Запрос.Текст = Запрос.Текст + 
				   "ИТОГИ
				   |	МАКСИМУМ(СложныйНалоговыйУчет),
				   |	МАКСИМУМ(Схема),
				   |	МАКСИМУМ(СуммаПревышенияОплатНадОтгрузкой),
				   |	СУММА(СуммаОтгрузки),
				   |	СУММА(СуммаНДСОтгрузки),
				   |	СУММА(СуммаАванс),
				   |	СУММА(СуммаНДСАванс)
				   |ПО
				   |	Контрагент,
				   |	РасчетыВозврат,
				   |	ЗаТару,
				   |	ДоговорКонтрагента,
				   |	Сделка";
				   Для каждого ДопПараметр Из ДопПараметры Цикл
		   		   Запрос.Текст = Запрос.Текст +",
				   |    "+ДопПараметр.Ключ;
				   КонецЦикла; 				   
	
	Объект.Договора.Очистить();

	Выборка1 = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока Выборка1.Следующий() Цикл // Контрагент
		Выборка2 = Выборка1.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока Выборка2.Следующий() Цикл //РасчетыВозврат
			Выборка3 = Выборка2.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока Выборка3.Следующий() Цикл //ЗаТару
				ВыборкаДоговора = Выборка3.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаДоговора.Следующий() Цикл  //ДоговорКонтрагента
					
					ВыборкаСделка = ВыборкаДоговора.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					Пока ВыборкаСделка.Следующий() Цикл  //Сделка
						СуммаНеПодтвержденнойОтгрузки    = ?(ВыборкаСделка.СуммаОтгрузки = NULL, 0, ВыборкаСделка.СуммаОтгрузки + ВыборкаСделка.СуммаНДСОтгрузки);
						СуммаПодтвержденногоАванса	     = ?(ВыборкаСделка.СуммаОтгрузки = NULL, 0, ВыборкаСделка.СуммаАванс + ВыборкаСделка.СуммаНДСАванс);
						СуммаПревышенияОплатНадОтгрузкой = ?(ВыборкаСделка.СуммаПревышенияОплатНадОтгрузкой = NULL, 0, ВыборкаСделка.СуммаПревышенияОплатНадОтгрузкой);
						
						Если НЕ ВыборкаСделка.СложныйНалоговыйУчет Тогда
						
							ДобавитьСтрокуВДоговора(Объект, ВыборкаСделка);
						
						ИначеЕсли ВыборкаСделка.Схема = Перечисления.МоментыОпределенияНалоговойБазы.НеОпределять Тогда
								
							// ничего не делаем
							Возврат;
								
						ИначеЕсли ВыборкаСделка.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоОплате Тогда
							
							Аванс = Макс(0, СуммаНеПодтвержденнойОтгрузки - СуммаПодтвержденногоАванса + СуммаПревышенияОплатНадОтгрузкой);
							
							Если Аванс > 0 Тогда
								ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаСделка, Аванс);
							КонецЕсли;
								
						ИначеЕсли ВыборкаСделка.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоОтгрузке Тогда
								
							// Все неподтвержденные отгрузки 
							ДобавитьСтрокуВДоговора(Объект, ВыборкаСделка);
								
						ИначеЕсли ВыборкаСделка.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоПервомуСобытию Тогда
							
							// Все неподтвержденные отгрузки
							ДобавитьСтрокуВДоговора(Объект, ВыборкаСделка);	
							
							//Дополнительно добавим аванс
							Аванс = Макс(0, СуммаПревышенияОплатНадОтгрузкой - СуммаПодтвержденногоАванса);
							
							Если Аванс > 0 Тогда
								// дополнительно добавим аванс
								ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаСделка, Аванс);
							КонецЕсли;
								
						Иначе
							
							Если ВыборкаСделка.ЗаТару Тогда
								ТекстСообщения = 
										  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Контрагент: %1, Договор: %2
|Не указана схема налогового учета по таре, либо в схеме не указан Момент определения базы НДС по продажам!';uk='Контрагент: %1, Договір: %2
|Не вказана схема податкового обліку по тарі, або в схемі не вказаний Момент визначення бази ПДВ по продажах!'"), ВыборкаСделка.Контрагент, ВыборкаСделка.ДоговорКонтрагента); 
							Иначе
								ТекстСообщения = 
										  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Контрагент: %1, Договор: %2
|Не указана схема налогового учета, либо в схеме не указан Момент определения базы НДС по продажам!';uk='Контрагент: %1, Договір: %2
|Не вказана схема податкового обліку, або в схемі не вказаний Момент визначення бази ПДВ по продажах!'"), ВыборкаСделка.Контрагент, ВыборкаСделка.ДоговорКонтрагента); 
							КонецЕсли;	
							
							Сообщить(ТекстСообщения, СтатусСообщения.Важное);

						КонецЕсли;					
						
					КонецЦикла; 	
				КонецЦикла; 	
			КонецЦикла; 	
		КонецЦикла; 	
	КонецЦикла; 	
	
	// Добавим в Договора строки, по которым нет остатков
	// в случае, если данная процедура вызвана в режиме обновления таблицы договоров (заполнен параметр ПараметрОтборДоговоровКонтрагентов)
	// И удалим  лишние (в запросе фильтр по Расчету/Возврату не накладывался)
	Если Не ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		// Добавляем новые
		Если НЕ ПараметрОтборДоговоровКонтрагентов.Колонки.Найти("ЗаТару") = Неопределено Тогда
			
			СтруктураПоиска = Новый Структура();
			Для каждого СтрокаТаблицыДокументов Из ПараметрОтборДоговоровКонтрагентов Цикл
				
				СтруктураПоиска.Вставить("ДоговорКонтрагента",	СтрокаТаблицыДокументов.ДоговорКонтрагента);		
				СтруктураПоиска.Вставить("Сделка",				СтрокаТаблицыДокументов.Сделка);		
				СтруктураПоиска.Вставить("РасчетыВозврат",		СтрокаТаблицыДокументов.РасчетыВозврат);		
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтруктураПоиска.Вставить(ДопПараметр.Ключ, СтрокаТаблицыДокументов[ДопПараметр.Ключ]);
				КонецЦикла;
				
				Если Объект.Договора.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
					СтрокаДоговоров = Объект.Договора.Добавить();
					СтрокаДоговоров.Дата = Объект.Дата;		
					Для каждого Параметр Из СтруктураПоиска Цикл
						СтрокаДоговоров[Параметр.Ключ] = Параметр.Значение;
					КонецЦикла;
					СтрокаДоговоров.ЗаТару    = СтрокаТаблицыДокументов.ЗаТару;		
					СтрокаДоговоров.СтавкаНДС = СтрокаТаблицыДокументов.СтавкаНДС;		
				КонецЕсли;
				
			КонецЦикла; 
			
		КонецЕсли;
		
		// Удаляем Лишние
		СтруктураПоиска = Новый Структура();
		Сч = 0;
		Пока Сч <= Объект.Договора.Количество() - 1 Цикл
			
			СтрокаДоговоров = Объект.Договора.Получить(Сч);
			СтруктураПоиска.Вставить("ДоговорКонтрагента",	СтрокаДоговоров.ДоговорКонтрагента);		
			СтруктураПоиска.Вставить("Сделка",				СтрокаДоговоров.Сделка);		
			СтруктураПоиска.Вставить("РасчетыВозврат",		СтрокаДоговоров.РасчетыВозврат);		
			
			Если ПараметрОтборДоговоровКонтрагентов.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
				Объект.Договора.Удалить(СтрокаДоговоров);
			Иначе
				Сч = Сч + 1
			КонецЕсли;
			
		КонецЦикла; 
		
	КонецЕсли;
	
	// добавим строки-ссылки на номенклатуру, добавляемую пользователем.
	ДоговораКопия = Объект.Договора.Выгрузить();
	ДоговораКопия.Свернуть("ДоговорКонтрагента, Сделка","");
	
	СтруктураПоиска = Новый Структура("ДоговорКонтрагента, Сделка, РасчетыВозврат, Документ");
	// если "возврат" (формируем Приложения 2) - необходимо всегда указывать документ-основание: налоговую накладную - основание!
	СтруктураПоиска.РасчетыВозврат 	= Перечисления.РасчетыВозврат.Расчеты;
	СтруктураПоиска.Документ 		= Неопределено;
	Для каждого СтрокаДоговоров Из ДоговораКопия Цикл
		
		СтруктураПоиска.ДоговорКонтрагента 	= СтрокаДоговоров.ДоговорКонтрагента;
		СтруктураПоиска.Сделка 				= СтрокаДоговоров.Сделка;
		
		СтрокиИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.НайтиСтроки(СтруктураПоиска);
		
		Если СтрокиИсточниковНоменклатуры.Количество() = 0 Тогда
			СтрокаИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.Добавить();
			СтрокаИсточниковНоменклатуры.Дата 					= Объект.Дата;		
			СтрокаИсточниковНоменклатуры.ДоговорКонтрагента 	= СтруктураПоиска.ДоговорКонтрагента;
			СтрокаИсточниковНоменклатуры.Сделка 				= СтруктураПоиска.Сделка;
			СтрокаИсточниковНоменклатуры.РасчетыВозврат 		= СтруктураПоиска.РасчетыВозврат;
			СтрокаИсточниковНоменклатуры.Документ	 	 		= Неопределено;	
		КонецЕсли;
	
	КонецЦикла;

КонецПроцедуры

Процедура ОбновитьДоговораПоДатам(Объект, ПараметрОтборДоговоровКонтрагентов)
	
	ДопПараметры = ПолучитьДопПараметры();	
	
	Запрос = Новый Запрос();
	
	Запрос.УстановитьПараметр("ПоОтгрузке", 			Перечисления.МоментыОпределенияНалоговойБазы.ПоОтгрузке);
	Запрос.УстановитьПараметр("ПоОплате",				Перечисления.МоментыОпределенияНалоговойБазы.ПоОплате);
	Запрос.УстановитьПараметр("ПоПервомуСобытию",		Перечисления.МоментыОпределенияНалоговойБазы.ПоПервомуСобытию);

	Запрос.УстановитьПараметр("Отгрузка", 		Перечисления.РасчетыВозврат.Расчеты);
	Запрос.УстановитьПараметр("Возврат", 		Перечисления.РасчетыВозврат.Возврат);
	
	МассивСобытияРасчет = Новый Массив();
	МассивСобытияРасчет.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ОплатаПокупателем);
	МассивСобытияРасчет.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.РеализацияПокупателю);
	Запрос.УстановитьПараметр("СобытияРасчет",			МассивСобытияРасчет);
	
	МассивСобытияВозврат = Новый Массив();
	МассивСобытияВозврат.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОплатыПокупателю);
	МассивСобытияВозврат.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОтПокупателя);
	Запрос.УстановитьПараметр("СобытияВозврат",			МассивСобытияВозврат);
	
	МассивСобытияОтгрузка = Новый Массив();
	МассивСобытияОтгрузка.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.РеализацияПокупателю);
	МассивСобытияОтгрузка.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОтПокупателя);
	Запрос.УстановитьПараметр("СобытияОтгрузка",			МассивСобытияОтгрузка);
	
	МассивСобытияОплата = Новый Массив();
	МассивСобытияОплата.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ОплатаПокупателем);
	МассивСобытияОплата.Добавить(Перечисления.СобытияПродажиНалоговыйУчет.ВозвратОплатыПокупателю);
	Запрос.УстановитьПараметр("СобытияОплата",			МассивСобытияОплата);

	Запрос.УстановитьПараметр("СобытияНДС_ОиП_Расчет",	Перечисления.СобытияОжидаемыйИПодтвержденныйНДСПродаж.Реализация);
	Запрос.УстановитьПараметр("СобытияНДС_ОиП_Возврат",	Перечисления.СобытияОжидаемыйИПодтвержденныйНДСПродаж.Возврат);

	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Запрос.УстановитьПараметр("ДоговорСКомиссионером", Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером);
	
	ДополнительныеУсловия = "";
	Если Не ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента В (&ДоговораКонтрагентов) И Сделка В (&Сделки) ";
		Запрос.УстановитьПараметр("ДоговораКонтрагентов", ПараметрОтборДоговоровКонтрагентов.ВыгрузитьКолонку("ДоговорКонтрагента"));
		Запрос.УстановитьПараметр("Сделки", ПараметрОтборДоговоровКонтрагентов.ВыгрузитьКолонку("Сделка"));
		
	Иначе
		
		ОтборДоговоров = Объект.ОтборДоговоровКонтрагентов.Выгрузить();
		ОтборДоговоров.Свернуть("ДоговорКонтрагента", "");
		СтрокаСПустымДоговором = ОтборДоговоров.Найти(Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
		Если НЕ СтрокаСПустымДоговором = Неопределено Тогда 
			ОтборДоговоров.Удалить(СтрокаСПустымДоговором);	
		КонецЕсли;
		
		// если остались строки, значит устанавливаем фильтр по договорам,
		// иначе - по контрагентам
		Если ОтборДоговоров.Количество() > 0 Тогда
			
			ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента В (&ДоговораКонтрагентов) ";
			Запрос.УстановитьПараметр("ДоговораКонтрагентов", ОтборДоговоров);
			
		Иначе 
			
			ОтборКонтрагентов = Объект.ОтборДоговоровКонтрагентов.Выгрузить();
			ОтборКонтрагентов.Свернуть("Контрагент", "");
			Если ОтборКонтрагентов.Количество() > 0 Тогда
				ДополнительныеУсловия =  ДополнительныеУсловия + " И ДоговорКонтрагента.Владелец В ИЕРАРХИИ(&Контрагенты) ";
				Запрос.УстановитьПараметр("Контрагенты", ОтборКонтрагентов);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;		
	
	Запрос.УстановитьПараметр("ДатаНач", 	НачалоДня(Объект.Дата));
	Запрос.УстановитьПараметр("ДатаКон", 	КонецДня(Объект.ДатаКон));
	
	ТекстЗапросаРасчеты=
		 "	ДанныеПС.Период		 			КАК Дата,
		  | Истина 							КАК СложныйНалоговыйУчет,
		  | &Отгрузка 						КАК РасчетыВозврат,
		  |	ДанныеПС.ДоговорКонтрагента.Владелец КАК Контрагент,
		  |	ДанныеПС.ДоговорКонтрагента 	КАК ДоговорКонтрагента,
		  |	ДанныеПС.Сделка 				КАК Сделка,
		  |	ДанныеПС.ЗаТару 				КАК ЗаТару,
		  |	ДанныеПС.Схема 					КАК Схема,
		  |	ВЫБОР
		  |		КОГДА ДанныеПС.Схема = &ПоОтгрузке
		  |			ТОГДА ДанныеПС.РасчетыОтгрузПрих
		  |		КОГДА ДанныеПС.Схема = &ПоОплате
		  |			ТОГДА ДанныеПС.РасчетыОплатаПрих
		  |		КОГДА ДанныеПС.Схема = &ПоПервомуСобытию
		  |			ТОГДА ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих > ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |						ТОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих
		  |					ИНАЧЕ ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |				КОНЕЦ - ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач > ДанныеПС.РасчетыОплатаНач
		  |						ТОГДА ДанныеПС.РасчетыОтгрузНач
		  |					ИНАЧЕ ДанныеПС.РасчетыОплатаНач
		  |				КОНЕЦ
		  |		ИНАЧЕ 0
		  |	КОНЕЦ КАК ПервоеСобытие,
		  |	ВЫБОР
		  |		КОГДА ДанныеПС.Схема = &ПоОтгрузке
		  |			ТОГДА ЛОЖЬ
		  |		КОГДА ДанныеПС.Схема = &ПоОплате
		  |			ТОГДА ИСТИНА
		  |		КОГДА ДанныеПС.Схема = &ПоПервомуСобытию
		  |			ТОГДА ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих > ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |						ТОГДА ЛОЖЬ
		  |						ИНАЧЕ ИСТИНА
		  |				  КОНЕЦ
          | КОНЕЦ КАК ЭтоАванс,
		  | ДанныеОтгрузка.СтавкаНДС 							   КАК	СтавкаНДС,		
		  | ДанныеОтгрузка.СуммаНДС								   КАК	СуммаНДСОтгрузки,
		  | ДанныеОтгрузка.БазаНДС								   КАК	СуммаОтгрузки,
		  | ЕстьNULL(ДанныеОтгрузка.РазличныеПараметрыОтгрузки, 0) КАК РазличныеПараметрыОтгрузки	
		  |
		  |ИЗ
		  |	(ВЫБРАТЬ
		  |		Суммы.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |		Суммы.Сделка 						КАК Сделка,
		  |		Суммы.ВозвратнаяТара 				КАК ЗаТару,
		  |		ВЫБОР
		  |			КОГДА Суммы.ВозвратнаяТара = ИСТИНА
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам
		  |			КОГДА Суммы.ВозвратнаяТара = ЛОЖЬ
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам
		  |		КОНЕЦ 								КАК Схема,
		  |		Суммы.ПериодДень 					КАК Период,
		  |		СУММА(Суммы.РасчетыОтгрузНач) 		КАК РасчетыОтгрузНач,
		  |		СУММА(Суммы.РасчетыОплатаНач) 		КАК РасчетыОплатаНач,
		  |		СУММА(Суммы.РасчетыОтгрузПрих)		КАК РасчетыОтгрузПрих,
		  |		СУММА(Суммы.РасчетыОплатаПрих) 		КАК РасчетыОплатаПрих
		  |	ИЗ
		  |		(ВЫБРАТЬ
		  |			Продажи.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |			Продажи.Сделка 						КАК Сделка,
		  |			Продажи.ВозвратнаяТара 				КАК ВозвратнаяТара,
		  |			НАЧАЛОПЕРИОДА(Продажи.Период, ДЕНЬ) КАК ПериодДень,
		  |			0 								КАК РасчетыОтгрузНач,
		  |			0 								КАК РасчетыОплатаНач,
		  |			ВЫБОР
		  |				КОГДА Продажи.Событие В (&СобытияОтгрузка)
		  |					ТОГДА Продажи.СуммаВзаиморасчетовПриход
		  |				ИНАЧЕ 0
		  |			КОНЕЦ 							КАК РасчетыОтгрузПрих,
		  |			ВЫБОР
		  |				КОГДА Продажи.Событие В (&СобытияОплата)
		  |					ТОГДА Продажи.СуммаВзаиморасчетовПриход
		  |				ИНАЧЕ 0
		  |			КОНЕЦ 							КАК РасчетыОплатаПрих
		  |		ИЗ
		  |			РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |				&ДатаНач,
		  |				&ДатаКон,
		  |				ДЕНЬ,
		  |				Событие В (&СобытияРасчет)                 
		  |				И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) " + ДополнительныеУсловия + "
		  |				И Организация = &Организация) КАК Продажи
		  |		
		  |		ОБЪЕДИНИТЬ ВСЕ
		  |		
		  |		ВЫБРАТЬ
		  |			Остатки.ДоговорКонтрагента,
		  |			Остатки.Сделка,
		  |			Остатки.ВозвратнаяТара,
		  |			Остатки.Период,
		  |			ВЫБОР
		  |				КОГДА Остатки.Событие В (&СобытияОтгрузка)
		  |					ТОГДА Остатки.НачальныйОстаток
		  |				ИНАЧЕ 0
		  |			КОНЕЦ,
		  |			ВЫБОР
		  |				КОГДА Остатки.Событие В (&СобытияОплата)
		  |					ТОГДА Остатки.НачальныйОстаток
		  |				ИНАЧЕ 0
		  |			КОНЕЦ,
		  |			0,
		  |			0
		  |		ИЗ
		  |			(ВЫБРАТЬ
		  |				Периоды.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |				Периоды.Сделка КАК Сделка,
		  |				Периоды.ВозвратнаяТара КАК ВозвратнаяТара,
		  |				Периоды.Период КАК Период,
		  |				Остатки.Событие КАК Событие,
		  |				ЕСТЬNULL(СУММА(Остатки.СуммаНач), 0) КАК НачальныйОстаток
		  |			ИЗ
		  |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
		  |					Периоды.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |					Периоды.Сделка КАК Сделка,
		  |					Периоды.ВозвратнаяТара КАК ВозвратнаяТара,
		  |					НАЧАЛОПЕРИОДА(Периоды.Период, ДЕНЬ) КАК Период
		  |				ИЗ
		  |					РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						Событие В (&СобытияРасчет)                   
		  |						И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером) " + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК Периоды) КАК Периоды
		  |					ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		  |						ОстНаНач.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |						ОстНаНач.Сделка КАК Сделка,
		  |						ОстНаНач.ВозвратнаяТара КАК ВозвратнаяТара,
		  |						ОстНаНач.Событие КАК Событие,
		  |						0 КАК Период,
		  |						ОстНаНач.СуммаВзаиморасчетовОстаток КАК СуммаНач
		  |					ИЗ
		  |						РегистрНакопления.ПродажиНалоговыйУчет.Остатки(
		  |							&ДатаНач,
		  |							Событие В (&СобытияРасчет)                 
		  |							И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК ОстНаНач
		  |					
		  |					ОБЪЕДИНИТЬ ВСЕ
		  |					
		  |					ВЫБРАТЬ
		  |						Обороты.ДоговорКонтрагента,
		  |						Обороты.Сделка,
		  |						Обороты.ВозвратнаяТара,
		  |						Обороты.Событие КАК Событие,
		  |						НАЧАЛОПЕРИОДА(Обороты.Период, ДЕНЬ) КАК Период,		  
		  |						Обороты.СуммаВзаиморасчетовОборот
		  |					ИЗ
		  |						РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |							&ДатаНач,
		  |							&ДатаКон,
		  |							День,
		  |							Событие В (&СобытияРасчет)                 
		  |							И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |							И Организация = &Организация) КАК Обороты) КАК Остатки
		  |					ПО 	  Остатки.ДоговорКонтрагента = Периоды.ДоговорКонтрагента
		  |						И Остатки.Сделка = Периоды.Сделка
		  |						И Остатки.ВозвратнаяТара = Периоды.ВозвратнаяТара
		  |						И (Остатки.Период = 0  ИЛИ Остатки.Период < НАЧАЛОПЕРИОДА(Периоды.Период, ДЕНЬ))
		  |			
		  |			СГРУППИРОВАТЬ ПО
		  |				Периоды.ДоговорКонтрагента,
		  |				Периоды.Сделка,
		  |				Периоды.ВозвратнаяТара,
		  |				Остатки.Событие,
		  |				Периоды.Период) КАК Остатки
		  |	   ) КАК Суммы
		  |	
		  |	СГРУППИРОВАТЬ ПО
		  |		Суммы.ДоговорКонтрагента,
		  |		Суммы.Сделка,
		  |		Суммы.ВозвратнаяТара,
		  |		Суммы.ПериодДень,
		  |		ВЫБОР
		  |			КОГДА Суммы.ВозвратнаяТара = ИСТИНА
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам
		  |			КОГДА Суммы.ВозвратнаяТара = ЛОЖЬ
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам
		  |		КОНЕЦ) КАК ДанныеПС
		  |
		  |  ЛЕВОЕ СОЕДИНЕНИЕ 
		  |       (ВЫБРАТЬ
		  |          Отгрузка.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |          Отгрузка.Сделка						КАК Сделка,
		  |          Отгрузка.ВозвратнаяТара				КАК ЗаТару,
		  |          НАЧАЛОПЕРИОДА(Отгрузка.Период, День) 	КАК Период,
		  |          МАКСИМУМ(Отгрузка.СтавкаНДС)			КАК СтавкаНДС,
		  |			 СУММА(1)								КАК РазличныеПараметрыОтгрузки,
		  |          СУММА(Отгрузка.БазаНДСПриход)			КАК БазаНДС,
		  |          СУММА(Отгрузка.СуммаНДСПриход)			КАК СуммаНДС
		  |		   ИЗ
		  |			РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						СобытиеНДС = &СобытияНДС_ОиП_Расчет        
		  |						И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК Отгрузка
		  |
		  |        СГРУППИРОВАТЬ ПО
		  |             Отгрузка.ДоговорКонтрагента,
		  |             Отгрузка.Сделка,
		  |             Отгрузка.ВозвратнаяТара,
		  |             НАЧАЛОПЕРИОДА(Отгрузка.Период, ДЕНЬ)) КАК ДанныеОтгрузка
		  |
		  |		ПО 	  ДанныеПС.ДоговорКонтрагента 	= ДанныеОтгрузка.ДоговорКонтрагента
		  |			И ДанныеПС.Сделка 				= ДанныеОтгрузка.Сделка
		  |			И ДанныеПС.ЗаТару 				= ДанныеОтгрузка.ЗаТару
		  |			И ДанныеПС.Период 				= ДанныеОтгрузка.Период
		  |
		  |ОБЪЕДИНИТЬ ВСЕ
		  |
		  |ВЫБРАТЬ
		  |	НАЧАЛОПЕРИОДА(ДанныеПС.Период, ДЕНЬ) КАК Дата,
		  | ЛОЖЬ 								 КАК СложныйНалоговыйУчет,
		  | &Отгрузка 							 КАК РасчетыВозврат,
		  |	ДанныеПС.ДоговорКонтрагента.Владелец КАК Контрагент,
		  |	ДанныеПС.ДоговорКонтрагента 		 КАК ДоговорКонтрагента,
		  |	ДанныеПС.Сделка 		 			 КАК Сделка,
		  |	ДанныеПС.ВозвратнаяТара				 КАК ЗаТару,
		  |	0	 						 		 КАК Схема,
		  |	0 									 КАК ПервоеСобытие,
		  |	0 									 КАК ЭтоАванс,
		  | ДанныеПС.СтавкаНДС 		КАК	СтавкаНДС,		
		  | ДанныеПС.СуммаНДСПриход	КАК	СуммаНДСОтгрузки,
		  | ДанныеПС.БазаНДСПриход	КАК	СуммаОтгрузки,
		  | 0 									 КАК РазличныеПараметрыОтгрузки	
		  |
		  |ИЗ
		  |РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						СобытиеНДС = &СобытияНДС_ОиП_Расчет           
		  |						И (НЕ ДоговорКонтрагента.СложныйНалоговыйУчет ИЛИ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК ДанныеПС
		  |
		  |";
	
					   
   ТекстЗапросаВозврат=
		 "	ДанныеПС.Период		 			КАК Дата,
		  | Истина 							КАК СложныйНалоговыйУчет,
		  | &Возврат 						КАК РасчетыВозврат,
		  |	ДанныеПС.ДоговорКонтрагента.Владелец КАК Контрагент,
		  |	ДанныеПС.ДоговорКонтрагента 	КАК ДоговорКонтрагента,
		  |	ДанныеПС.Сделка				 	КАК Сделка,
		  |	ДанныеПС.ЗаТару 				КАК ЗаТару,
		  |	ДанныеПС.Схема 					КАК Схема,
		  |	ВЫБОР
		  |		КОГДА ДанныеПС.Схема = &ПоОтгрузке
		  |			ТОГДА ДанныеПС.РасчетыОтгрузПрих
		  |		КОГДА ДанныеПС.Схема = &ПоОплате
		  |			ТОГДА ДанныеПС.РасчетыОплатаПрих
		  |		КОГДА ДанныеПС.Схема = &ПоПервомуСобытию
		  |			ТОГДА ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих > ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |						ТОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих
		  |					ИНАЧЕ ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |				КОНЕЦ - ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач > ДанныеПС.РасчетыОплатаНач
		  |						ТОГДА ДанныеПС.РасчетыОтгрузНач
		  |					ИНАЧЕ ДанныеПС.РасчетыОплатаНач
		  |				КОНЕЦ
		  |		ИНАЧЕ 0
		  |	КОНЕЦ КАК ПервоеСобытие,
		  |	ВЫБОР
		  |		КОГДА ДанныеПС.Схема = &ПоОтгрузке
		  |			ТОГДА ЛОЖЬ
		  |		КОГДА ДанныеПС.Схема = &ПоОплате
		  |			ТОГДА ИСТИНА
		  |		КОГДА ДанныеПС.Схема = &ПоПервомуСобытию
		  |			ТОГДА ВЫБОР
		  |					КОГДА ДанныеПС.РасчетыОтгрузНач + ДанныеПС.РасчетыОтгрузПрих > ДанныеПС.РасчетыОплатаНач + ДанныеПС.РасчетыОплатаПрих
		  |						ТОГДА ЛОЖЬ
		  |						ИНАЧЕ ИСТИНА
		  |				  КОНЕЦ
          | КОНЕЦ КАК ЭтоАванс,
		  | ДанныеОтгрузка.СтавкаНДС 								КАК	СтавкаНДС,		
		  | ДанныеОтгрузка.СуммаНДС									КАК	СуммаНДСОтгрузки,
		  | ДанныеОтгрузка.БазаНДС							    	КАК	СуммаОтгрузки,
		  | ЕстьNULL(ДанныеОтгрузка.РазличныеПараметрыОтгрузки,0) 	КАК РазличныеПараметрыОтгрузки	
		  |
		  |ИЗ
		  |	(ВЫБРАТЬ
		  |		Суммы.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |		Суммы.Сделка		 				КАК Сделка,
		  |		Суммы.ВозвратнаяТара 				КАК ЗаТару,
		  |		ВЫБОР
		  |			КОГДА Суммы.ВозвратнаяТара = ИСТИНА
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам
		  |			КОГДА Суммы.ВозвратнаяТара = ЛОЖЬ
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам
		  |		КОНЕЦ 								КАК Схема,
		  |		Суммы.ПериодДень 					КАК Период,
		  |		СУММА(Суммы.РасчетыОтгрузНач) 		КАК РасчетыОтгрузНач,
		  |		СУММА(Суммы.РасчетыОплатаНач) 		КАК РасчетыОплатаНач,
		  |		СУММА(Суммы.РасчетыОтгрузПрих)		КАК РасчетыОтгрузПрих,
		  |		СУММА(Суммы.РасчетыОплатаПрих) 		КАК РасчетыОплатаПрих
		  |	ИЗ
		  |		(ВЫБРАТЬ
		  |			Продажи.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |			Продажи.Сделка 						КАК Сделка,
		  |			Продажи.ВозвратнаяТара 				КАК ВозвратнаяТара,
		  |			НАЧАЛОПЕРИОДА(Продажи.Период, ДЕНЬ) КАК ПериодДень,
		  |			0 								КАК РасчетыОтгрузНач,
		  |			0 								КАК РасчетыОплатаНач,
		  |			ВЫБОР
		  |				КОГДА Продажи.Событие В (&СобытияОтгрузка)
		  |					ТОГДА Продажи.СуммаВзаиморасчетовПриход
		  |				ИНАЧЕ 0
		  |			КОНЕЦ 							КАК РасчетыОтгрузПрих,
		  |			ВЫБОР
		  |				КОГДА Продажи.Событие В (&СобытияОплата)
		  |					ТОГДА Продажи.СуммаВзаиморасчетовПриход
		  |				ИНАЧЕ 0
		  |			КОНЕЦ 							КАК РасчетыОплатаПрих
		  |		ИЗ
		  |			РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |				&ДатаНач,
		  |				&ДатаКон,
		  |				ДЕНЬ,
		  |				Событие В (&СобытияВозврат)                
		  |				И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |				И Организация = &Организация) КАК Продажи
		  |		
		  |		ОБЪЕДИНИТЬ ВСЕ
		  |		
		  |		ВЫБРАТЬ
		  |			Остатки.ДоговорКонтрагента,
		  |			Остатки.Сделка,
		  |			Остатки.ВозвратнаяТара,
		  |			Остатки.Период,
		  |			ВЫБОР
		  |				КОГДА Остатки.Событие В (&СобытияОтгрузка)
		  |					ТОГДА Остатки.НачальныйОстаток
		  |				ИНАЧЕ 0
		  |			КОНЕЦ,
		  |			ВЫБОР
		  |				КОГДА Остатки.Событие В (&СобытияОплата)
		  |					ТОГДА Остатки.НачальныйОстаток
		  |				ИНАЧЕ 0
		  |			КОНЕЦ,
		  |			0,
		  |			0
		  |		ИЗ
		  |			(ВЫБРАТЬ
		  |				Периоды.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |				Периоды.Сделка КАК Сделка,
		  |				Периоды.ВозвратнаяТара КАК ВозвратнаяТара,
		  |				Периоды.Период КАК Период,
		  |				Остатки.Событие КАК Событие,
		  |				ЕСТЬNULL(СУММА(Остатки.СуммаНач), 0) КАК НачальныйОстаток
		  |			ИЗ
		  |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
		  |					Периоды.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |					Периоды.Сделка КАК Сделка,
		  |					Периоды.ВозвратнаяТара КАК ВозвратнаяТара,
		  |					НАЧАЛОПЕРИОДА(Периоды.Период, ДЕНЬ) КАК Период
		  |				ИЗ
		  |					РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						Событие В (&СобытияВозврат)                
		  |						И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК Периоды) КАК Периоды
		  |					ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		  |						ОстНаНач.ДоговорКонтрагента КАК ДоговорКонтрагента,
		  |						ОстНаНач.Сделка КАК Сделка,
		  |						ОстНаНач.ВозвратнаяТара КАК ВозвратнаяТара,
		  |						ОстНаНач.Событие КАК Событие,
		  |						0 КАК Период,
		  |						ОстНаНач.СуммаВзаиморасчетовОстаток КАК СуммаНач
		  |					ИЗ
		  |						РегистрНакопления.ПродажиНалоговыйУчет.Остатки(
		  |							&ДатаНач,
		  |							Событие В (&СобытияВозврат)            
		  |						И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК ОстНаНач
		  |					
		  |					ОБЪЕДИНИТЬ ВСЕ
		  |					
		  |					ВЫБРАТЬ
		  |						Обороты.ДоговорКонтрагента,
		  |						Обороты.Сделка,
		  |						Обороты.ВозвратнаяТара,
		  |						Обороты.Событие КАК Событие,
		  |						НАЧАЛОПЕРИОДА(Обороты.Период, ДЕНЬ) КАК Период,		  
		  |						Обороты.СуммаВзаиморасчетовОборот
		  |					ИЗ
		  |						РегистрНакопления.ПродажиНалоговыйУчет.Обороты(
		  |							&ДатаНач,
		  |							&ДатаКон,
		  |							День,
		  |							Событие В (&СобытияВозврат)                
		  |							И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |							И Организация = &Организация) КАК Обороты) КАК Остатки
		  |					ПО 	  Остатки.ДоговорКонтрагента = Периоды.ДоговорКонтрагента
		  |						И Остатки.Сделка = Периоды.Сделка
		  |						И Остатки.ВозвратнаяТара = Периоды.ВозвратнаяТара
		  |						И (Остатки.Период = 0  ИЛИ Остатки.Период < НАЧАЛОПЕРИОДА(Периоды.Период, ДЕНЬ))
		  |			
		  |			СГРУППИРОВАТЬ ПО
		  |				Периоды.ДоговорКонтрагента,
		  |				Периоды.Сделка,
		  |				Периоды.ВозвратнаяТара,
		  |				Остатки.Событие,
		  |				Периоды.Период) КАК Остатки
		  |	   ) КАК Суммы
		  |	
		  |	СГРУППИРОВАТЬ ПО
		  |		Суммы.ДоговорКонтрагента,
		  |		Суммы.Сделка,
		  |		Суммы.ВозвратнаяТара,
		  |		Суммы.ПериодДень,
		  |		ВЫБОР
		  |			КОГДА Суммы.ВозвратнаяТара = ИСТИНА
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчетаПоТаре.МоментОпределенияБазыНДСПоПродажам
		  |			КОГДА Суммы.ВозвратнаяТара = ЛОЖЬ
		  |				ТОГДА Суммы.ДоговорКонтрагента.СхемаНалоговогоУчета.МоментОпределенияБазыНДСПоПродажам
		  |		КОНЕЦ) КАК ДанныеПС
		  |
		  |  ЛЕВОЕ СОЕДИНЕНИЕ 
		  |       (ВЫБРАТЬ
		  |          Отгрузка.ДоговорКонтрагента 			КАК ДоговорКонтрагента,
		  |          Отгрузка.Сделка						КАК Сделка,
		  |          Отгрузка.ВозвратнаяТара				КАК ЗаТару,
		  |          НАЧАЛОПЕРИОДА(Отгрузка.Период, День) 	КАК Период,
		  |          МАКСИМУМ(Отгрузка.СтавкаНДС)			КАК СтавкаНДС,
		  |			 СУММА(1)								КАК РазличныеПараметрыОтгрузки,
		  |          СУММА(Отгрузка.БазаНДСПриход)			КАК БазаНДС,
		  |          СУММА(Отгрузка.СуммаНДСПриход)			КАК СуммаНДС
		  |		   ИЗ
		  |			РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						СобытиеНДС = &СобытияНДС_ОиП_Возврат 
		  |						И (ДоговорКонтрагента.СложныйНалоговыйУчет И НЕ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК Отгрузка
		  |
		  |        СГРУППИРОВАТЬ ПО
		  |             Отгрузка.ДоговорКонтрагента,
		  |             Отгрузка.Сделка,
		  |             Отгрузка.ВозвратнаяТара,
		  |             НАЧАЛОПЕРИОДА(Отгрузка.Период, ДЕНЬ)) КАК ДанныеОтгрузка
		  |
		  |		ПО 	  ДанныеПС.ДоговорКонтрагента 	= ДанныеОтгрузка.ДоговорКонтрагента
		  |			И ДанныеПС.Сделка 				= ДанныеОтгрузка.Сделка
		  |			И ДанныеПС.ЗаТару 				= ДанныеОтгрузка.ЗаТару
		  |			И ДанныеПС.Период 				= ДанныеОтгрузка.Период
		  |
		  |ОБЪЕДИНИТЬ ВСЕ
		  |
		  |ВЫБРАТЬ
		  |	НАЧАЛОПЕРИОДА(ДанныеПС.Период, ДЕНЬ) КАК Дата,
		  | ЛОЖЬ 								 КАК СложныйНалоговыйУчет,
		  | &Возврат 							 КАК РасчетыВозврат,
		  |	ДанныеПС.ДоговорКонтрагента.Владелец КАК Контрагент,
		  |	ДанныеПС.ДоговорКонтрагента 		 КАК ДоговорКонтрагента,
		  |	ДанныеПС.Сделка				 		 КАК Сделка,
		  |	ДанныеПС.ВозвратнаяТара				 КАК ЗаТару,
		  |	0	 						 		 КАК Схема,
		  |	0 									 КАК ПервоеСобытие,
		  |	0 									 КАК ЭтоАванс,
		  | ДанныеПС.СтавкаНДС 	КАК	СтавкаНДС,		
		  | ДанныеПС.СуммаНДСПриход	КАК	СуммаНДСОтгрузки,
		  | ДанныеПС.БазаНДСПриход	КАК	СуммаОтгрузки,
		  | 0 									 КАК РазличныеПараметрыОтгрузки	
		  |
		  |ИЗ
		  |РегистрНакопления.ОжидаемыйИПодтвержденныйНДСПродаж.Обороты(
		  |						&ДатаНач,
		  |						&ДатаКон,
		  |						ДЕНЬ,
		  |						СобытиеНДС = &СобытияНДС_ОиП_Возврат  
		  |						И (НЕ ДоговорКонтрагента.СложныйНалоговыйУчет ИЛИ ДоговорКонтрагента.ВидДоговора = &ДоговорСКомиссионером)" + ДополнительныеУсловия + "
		  |						И Организация = &Организация) КАК ДанныеПС
		  |
		  |";
	
   

	Если  НЕ ЗначениеЗаполнено(Объект.РасчетыВозврат) = Ложь
		И ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		Если Объект.РасчетыВозврат = Перечисления.РасчетыВозврат.Расчеты Тогда
			Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
							|" +ТекстЗапросаРасчеты;	
		Иначе
			Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
							|" +ТекстЗапросаВозврат;	
		КонецЕсли; 
		
	Иначе
		Запрос.Текст = 	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
						|" + ТекстЗапросаРасчеты + "
						| ОБЪЕДИНИТЬ ВСЕ
						|
						|ВЫБРАТЬ
						|" + ТекстЗапросаВозврат;
	КонецЕсли;
					
	Запрос.Текст = Запрос.Текст + 
				   "УПОРЯДОЧИТЬ ПО 
				   |	Контрагент,
				   |	ДоговорКонтрагента,
				   |	Дата,
				   |	РасчетыВозврат,
				   |	ЗаТару
				   |";
	
	Объект.Договора.Очистить();

	ВыборкаДоговора = Запрос.Выполнить().Выбрать();
	Пока ВыборкаДоговора.Следующий() Цикл  
		
		ВыдатьПредупраждающееСообщение = Ложь;
		
		Если  ВыборкаДоговора.ПервоеСобытие <= 0
			И ВыборкаДоговора.СложныйНалоговыйУчет Тогда
		
			Продолжить;	
		
		КонецЕсли;
		
		Если НЕ ВыборкаДоговора.СложныйНалоговыйУчет Тогда
			
			ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаДоговора);
			 
		ИначеЕсли ВыборкаДоговора.Схема = Перечисления.МоментыОпределенияНалоговойБазы.НеОпределять Тогда
								
			// ничего не делаем
			Возврат;
								
		ИначеЕсли ВыборкаДоговора.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоОплате Тогда
							
			Аванс = ВыборкаДоговора.ПервоеСобытие;
							
			Если  Аванс > 0 Тогда
				ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаДоговора, Аванс);
			КонецЕсли;
								
		ИначеЕсли ВыборкаДоговора.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоОтгрузке Тогда
								
			// Все отгрузки 
			Если ВыборкаДоговора.РазличныеПараметрыОтгрузки =  1 Тогда
			
				ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаДоговора);	
			
			Иначе
				
				// вариант когда при учете по отгрузке были отгрузки по нескольким ставкам не обрабатывается в полном объеме.
				Отгрузка = ВыборкаДоговора.ПервоеСобытие;
								
				ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаДоговора, Отгрузка);
				
				ВыдатьПредупраждающееСообщение = Истина;
				
			КонецЕсли;
								
		ИначеЕсли ВыборкаДоговора.Схема = Перечисления.МоментыОпределенияНалоговойБазы.ПоПервомуСобытию Тогда
							
			
			Если ВыборкаДоговора.ЭтоАванс  Тогда
				
				Аванс = ВыборкаДоговора.ПервоеСобытие;
								
				ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаДоговора, Аванс);
			
			ИначеЕсли ВыборкаДоговора.РазличныеПараметрыОтгрузки = 1  Тогда
				
				Если ВыборкаДоговора.СуммаОтгрузки + ВыборкаДоговора.СуммаНДСОтгрузки > 0 Тогда
				
					ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаДоговора, ВыборкаДоговора.ПервоеСобытие/(ВыборкаДоговора.СуммаОтгрузки + ВыборкаДоговора.СуммаНДСОтгрузки));	
				
				Иначе
					
					// по-видимому излишне выписаны налоговые накладные, но это должен выявить пользователь с помощью отчетов
					Отгрузка = ВыборкаДоговора.ПервоеСобытие;
									
					ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаДоговора, Отгрузка);
					
					ВыдатьПредупраждающееСообщение = Истина;
					
				КонецЕсли;
				
			Иначе
				
				Отгрузка = ВыборкаДоговора.ПервоеСобытие;
								
				ДобавитьСтрокуВДоговораАванс(Объект, ВыборкаДоговора, Отгрузка);
				
				ВыдатьПредупраждающееСообщение = Истина
				
			КонецЕсли;
			
		Иначе
							
			Если ВыборкаДоговора.ЗаТару Тогда
				ТекстСообщения = 
						  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Контрагент: %1, Договор: %2
|Не указана схема налогового учета по таре, либо в схеме не указан Момент определения базы НДС по продажам!';uk='Контрагент: %1, Договір: %2
|Не вказана схема податкового обліку по тарі, або в схемі не вказаний Момент визначення бази ПДВ по продажах!'"), ВыборкаДоговора.Контрагент, ВыборкаДоговора.ДоговорКонтрагента); 
			Иначе
				ТекстСообщения = 
						  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Контрагент: %1, Договор: %2
|Не указана схема налогового учета, либо в схеме не указан Момент определения базы НДС по продажам!';uk='Контрагент: %1, Договір: %2
|Не вказана схема податкового обліку, або в схемі не вказаний Момент визначення бази ПДВ по продажах!'"), ВыборкаДоговора.Контрагент, ВыборкаДоговора.ДоговорКонтрагента); 
			КонецЕсли;	
							
			Сообщить(ТекстСообщения, СтатусСообщения.Важное);

		КонецЕсли;					
		
		Если ВыдатьПредупраждающееСообщение Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Контрагент: %1, Договор: %2, Дата:  %3
|Нет возможности определить параметры (ставка, счет учета) налоговых обязательств. Общая сумма обязательств указана в колонке ""Аванс""!';uk='Контрагент: %1, Договір: %2, Дата:  %3
|Нема можливості визначити параметри (ставка, рахунок обліку) податкових зобов''язень. Загальна сума зобов''язень вказана у колонці ""Аванс""'"), ВыборкаДоговора.Контрагент, ВыборкаДоговора.ДоговорКонтрагента, Формат(ВыборкаДоговора.Дата,"ДФ=dd.MM.yyyy")); 
			
			Сообщить(ТекстСообщения, СтатусСообщения.Информация);
			
		КонецЕсли;
		
	КонецЦикла; 	
	
	// Добавим в Договора строки, по которым нет остатков
	// в случае, если данная процедура вызвана в режиме обновления таблицы договоров (заполнен параметр ПараметрОтборДоговоровКонтрагентов)
	// И удалим  лишние (в запросе фильтр по Расчету/Возврату не накладывался)
	Если Не ПараметрОтборДоговоровКонтрагентов = Неопределено Тогда
		
		// Добавляем новые
		Если НЕ ПараметрОтборДоговоровКонтрагентов.Колонки.Найти("ЗаТару") = Неопределено Тогда

			СтруктураПоиска = Новый Структура();
			Для каждого СтрокаТаблицыДокументов Из ПараметрОтборДоговоровКонтрагентов Цикл
				
				СтруктураПоиска.Вставить("Дата",				СтрокаТаблицыДокументов.Дата);		
				СтруктураПоиска.Вставить("ДоговорКонтрагента",	СтрокаТаблицыДокументов.ДоговорКонтрагента);		
				СтруктураПоиска.Вставить("Сделка",				СтрокаТаблицыДокументов.Сделка);		
				СтруктураПоиска.Вставить("РасчетыВозврат",		СтрокаТаблицыДокументов.РасчетыВозврат);		
				Для каждого ДопПараметр Из ДопПараметры Цикл
					СтруктураПоиска.Вставить(ДопПараметр.Ключ, СтрокаТаблицыДокументов[ДопПараметр.Ключ]);
				КонецЦикла;
				
				Если Объект.Договора.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
					СтрокаДоговоров = Объект.Договора.Добавить();
					СтрокаДоговоров.Дата = СтрокаТаблицыДокументов.Дата;		
					Для каждого Параметр Из СтруктураПоиска Цикл
						СтрокаДоговоров[Параметр.Ключ] = Параметр.Значение;
					КонецЦикла;
					СтрокаДоговоров.ЗаТару    = СтрокаТаблицыДокументов.ЗаТару;		
					СтрокаДоговоров.СтавкаНДС = СтрокаТаблицыДокументов.СтавкаНДС;		
				КонецЕсли;
				
			КонецЦикла; 
			
		КонецЕсли;

		// Удаляем Лишние
		СтруктураПоиска = Новый Структура();
		Сч = 0;
		Пока Сч <= Объект.Договора.Количество() - 1 Цикл
			
			СтрокаДоговоров = Объект.Договора.Получить(Сч);
			СтруктураПоиска.Вставить("Дата",	СтрокаДоговоров.Дата);		
			СтруктураПоиска.Вставить("ДоговорКонтрагента",	СтрокаДоговоров.ДоговорКонтрагента);		
			СтруктураПоиска.Вставить("Сделка",				СтрокаДоговоров.Сделка);		
			СтруктураПоиска.Вставить("РасчетыВозврат",		СтрокаДоговоров.РасчетыВозврат);		
			
			Если ПараметрОтборДоговоровКонтрагентов.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
				Объект.Договора.Удалить(СтрокаДоговоров);
			Иначе
				Сч = Сч + 1
			КонецЕсли;
			
		КонецЦикла; 
		
	КонецЕсли;
	
	// добавим строки-ссылки на номенклатуру, добавляемую пользователем.
	ДоговораКопия = Объект.Договора.Выгрузить();
	ДоговораКопия.Свернуть("Дата, ДоговорКонтрагента, Сделка","");
	
	СтруктураПоиска = Новый Структура("Дата, ДоговорКонтрагента, Сделка, РасчетыВозврат, Документ");
	// если "возврат" (формируем Приложения 2) - необходимо всегда указывать документ-основание: налоговую накладную - основание!
	СтруктураПоиска.РасчетыВозврат 	= Перечисления.РасчетыВозврат.Расчеты;
	СтруктураПоиска.Документ 		= Неопределено;
	Для каждого СтрокаДоговоров Из ДоговораКопия Цикл
		СтруктураПоиска.Дата 				= СтрокаДоговоров.Дата;
		СтруктураПоиска.ДоговорКонтрагента 	= СтрокаДоговоров.ДоговорКонтрагента;
		СтруктураПоиска.Сделка 				= СтрокаДоговоров.Сделка;
		
		СтрокиИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.НайтиСтроки(СтруктураПоиска);
		Если СтрокиИсточниковНоменклатуры.Количество() = 0 Тогда
			СтрокаИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.Добавить();
			СтрокаИсточниковНоменклатуры.Дата 					= СтруктураПоиска.Дата;		
			СтрокаИсточниковНоменклатуры.ДоговорКонтрагента 	= СтруктураПоиска.ДоговорКонтрагента;
			СтрокаИсточниковНоменклатуры.Сделка 				= СтруктураПоиска.Сделка;
			СтрокаИсточниковНоменклатуры.РасчетыВозврат 		= СтруктураПоиска.РасчетыВозврат;
			СтрокаИсточниковНоменклатуры.Документ	 	 		= Неопределено;	
		КонецЕсли;
	
	КонецЦикла;
	
	//теперь добавим уже выписанные  налоговые документы
	//Сначала удалим старые упоминания
	СтруктураОтбора = новый Структура("СуществующийДокумент", истина);
	УдалитьСтрокиТабличныхЧастейНоменклатуры(Объект, СтруктураОтбора);
	УдалитьСтрокиТабличнойЧасти(Объект.ИсточникиНоменклатуры, СтруктураОтбора);
	
	// Получим таблицу с датами/договорами для поиска выписанных документов
	ТаблицаДоговоров = Объект.Договора.Выгрузить();
	ТаблицаДоговоров.Свернуть("Дата,ДоговорКонтрагента,Сделка, РасчетыВозврат","");
	
	ОтборИсточниковНоменклатуры = Новый Структура();
	
	Для каждого Строка Из ТаблицаДоговоров Цикл
	    // находим существующие налоговые документы
		Если Строка.РасчетыВозврат = Перечисления.РасчетыВозврат.Расчеты Тогда
		
			СуществующиеДокументы = Документы.НалоговаяНакладная.Выбрать(НачалоДня(Строка.Дата),
																		 КонецДня(Строка.Дата), 
																		 Новый Структура("ДоговорКонтрагента", Строка.ДоговорКонтрагента),
																		 "Дата");
		Иначе
																		 
			СуществующиеДокументы = Документы.Приложение2КНалоговойНакладной.Выбрать(НачалоДня(Строка.Дата),
																					 КонецДня(Строка.Дата), 
																					 Новый Структура("ДоговорКонтрагента", Строка.ДоговорКонтрагента),
																					 "Дата");

		КонецЕсли;	
		
		// добавляем существующие налоговые документы
		Пока СуществующиеДокументы.Следующий() Цикл
				
			Если СуществующиеДокументы.Проведен = Ложь Тогда
				Продолжить;
			КонецЕсли;
			
			Если НЕ СуществующиеДокументы.Сделка = Строка.Сделка 
			   И НЕ (НЕ ЗначениеЗаполнено(СуществующиеДокументы.Сделка) И НЕ ЗначениеЗаполнено(Строка.Сделка)) Тогда
					Продолжить;
			КонецЕсли;
			
			СтрокаИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.Добавить();
			СтрокаИсточниковНоменклатуры.Дата	 			= Строка.Дата;
			СтрокаИсточниковНоменклатуры.СуществующийДокумент = Истина;
			СтрокаИсточниковНоменклатуры.Документ 			= СуществующиеДокументы.Ссылка;
			СтрокаИсточниковНоменклатуры.ДоговорКонтрагента = Строка.ДоговорКонтрагента;
			СтрокаИсточниковНоменклатуры.Сделка 			= Строка.Сделка;
			СтрокаИсточниковНоменклатуры.РасчетыВозврат 	= Строка.РасчетыВозврат;
			
			ОтборИсточниковНоменклатуры.Вставить("Дата",					СтрокаИсточниковНоменклатуры.Дата);
			ОтборИсточниковНоменклатуры.Вставить("СуществующийДокумент", 	Истина);
			ОтборИсточниковНоменклатуры.Вставить("Документ",				СтрокаИсточниковНоменклатуры.Документ);
			ОтборИсточниковНоменклатуры.Вставить("ДоговорКонтрагента",		СтрокаИсточниковНоменклатуры.ДоговорКонтрагента);
			ОтборИсточниковНоменклатуры.Вставить("Сделка",					СтрокаИсточниковНоменклатуры.Сделка);
			ОтборИсточниковНоменклатуры.Вставить("РасчетыВозврат",			СтрокаИсточниковНоменклатуры.РасчетыВозврат);
			
			ЗаполнитьТабличныеЧасти(Объект, ОтборИсточниковНоменклатуры);
			
		КонецЦикла; 
	
	КонецЦикла; 

КонецПроцедуры

Процедура ДобавитьСтрокуВДоговора(Объект, Выборка) 
	
	ДопПараметры = ПолучитьДопПараметры();
	
	ВыборкаСтавка = Выборка.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаСтавка.Следующий() Цикл
		
		Если ДопПараметры.Количество() = 0 Тогда
			ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаСтавка);	
			Продолжить;	
		КонецЕсли;
					
		ВыборкаДоп1 = ВыборкаСтавка.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаДоп1.Следующий() Цикл 
						
			Если ДопПараметры.Количество() = 1 Тогда
				ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаДоп1);	
				Продолжить;	
			КонецЕсли;
						
			ВыборкаДоп2 = ВыборкаДоп1.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаДоп2.Следующий() Цикл 
				Если ДопПараметры.Количество() = 2 Тогда
					ДобавитьСтрокуВДоговораОтгрузка(Объект, ВыборкаДоп2);	
					Продолжить;	
				КонецЕсли;
							
				// служебное сообщение
				Сообщить(НСтр("ru='Количество доп. параметров превышает 2!';uk='Кількість дод. параметрів перевищує 2!'"));
							
			КонецЦикла;
			
		КонецЦикла;		
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьСтрокуВДоговораОтгрузка(Объект, Выборка, Коэффициент = 1)		
	
	ДопПараметры = ПолучитьДопПараметры();
	
	Если  Выборка.СуммаОтгрузки = NULL 
	  ИЛИ Выборка.СуммаОтгрузки + Выборка.СуммаНДСОтгрузки <= 0  Тогда
	  
	  Возврат
	  
    КонецЕсли;
	
	СтрокаДоговоров = Объект.Договора.Добавить();
	
	СтрокаДоговоров.Дата		 		= Выборка.Дата;
	СтрокаДоговоров.РасчетыВозврат 		= Выборка.РасчетыВозврат;
	СтрокаДоговоров.ДоговорКонтрагента 	= Выборка.ДоговорКонтрагента;
	СтрокаДоговоров.Сделка 				= Выборка.Сделка;
	СтрокаДоговоров.ЗаТару 				= Выборка.ЗаТару;
	СтрокаДоговоров.СтавкаНДС 			= Выборка.СтавкаНДС;
	
	Для каждого ДопПараметр Из ДопПараметры Цикл
		СтрокаДоговоров[ДопПараметр.Ключ]= Выборка[ДопПараметр.Ключ];
	КонецЦикла; 	

	СтрокаДоговоров.Сумма 		= Коэффициент * (Выборка.СуммаОтгрузки + Выборка.СуммаНДСОтгрузки);
	СтрокаДоговоров.СуммаНДС	= Коэффициент * (Выборка.СуммаНДСОтгрузки);
	
КонецПроцедуры

Процедура ДобавитьСтрокуВДоговораАванс(Объект, Выборка, Аванс) 
	
	СтрокаДоговоров = Объект.Договора.Добавить();
	
	СтрокаДоговоров.Дата		 		= Выборка.Дата;
	Если СтрокаДоговоров.Дата = '00010101' Тогда
		СтрокаДоговоров.Дата = Объект.Дата;	
	КонецЕсли;
	СтрокаДоговоров.РасчетыВозврат 		= Выборка.РасчетыВозврат;
	СтрокаДоговоров.ДоговорКонтрагента 	= Выборка.ДоговорКонтрагента;
	СтрокаДоговоров.Сделка 				= Выборка.Сделка;
	СтрокаДоговоров.ЗаТару 				= Выборка.ЗаТару;
	СтрокаДоговоров.Сумма 				= Аванс;
	
КонецПроцедуры

Процедура ЗаполнитьТабличнуюЧасть(Объект, ИмяТабличнойЧастиДокумента, СтруктураОтбора)
	Перем ИмяТабличнойЧастиОбработки;
	
	Документ = СтруктураОтбора.Документ;
	
	// ИНАГРО++ Элеватор
	Если Документ = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Если Документ.Метаданные().Имя = "ИНАГРО_Переоформление" Тогда 
		ИмяТабличнойЧастиОбработки = "Товары";
	Иначе 	
		ИмяТабличнойЧастиОбработки = ИмяТабличнойЧастиДокумента;
	КонецЕсли; 
	// ИНАГРО-- Элеватор
		
	Если Документ.Метаданные().ТабличныеЧасти.Найти(ИмяТабличнойЧастиДокумента) = Неопределено Тогда
		// нет такой табличной части
		Возврат
	КонецЕсли;
	
	КолокниТЧОбработки = Метаданные.Обработки.ФормированиеНалоговыхНакладных.ТабличныеЧасти.Найти(ИмяТабличнойЧастиОбработки).Реквизиты;		
	КолокниТЧДокумента = Документ.Метаданные().ТабличныеЧасти.Найти(ИмяТабличнойЧастиДокумента).Реквизиты;
	
	// ИНАГРО++
	Если Документ.Метаданные().Имя = "ИНАГРО_ВедомостьРеализация" И Документ.ЭтоУслуга И ИмяТабличнойЧастиДокумента = "Услуги" Тогда 
		ТабличнаяЧастьДокумента = Документ.Услуги.Выгрузить();
		ТабличнаяЧастьДокумента.Свернуть("Номенклатура, Цена, СтавкаНДС, СхемаРеализации, НалоговоеНазначение, Содержание",
										 "Количество, Сумма, СуммаНДС, Всего"); 		
	ИначеЕсли Документ.Метаданные().Имя = "ИНАГРО_ВедомостьРеализация" И НЕ Документ.ЭтоУслуга  И ИмяТабличнойЧастиДокумента = "Товары" Тогда 
		ТабличнаяЧастьДокумента = Документ.Товары.Выгрузить();				
		ТабличнаяЧастьДокумента.Свернуть("Номенклатура, Цена, СтавкаНДС, ЕдиницаИзмерения, Коэффициент, СхемаРеализации, НалоговоеНазначение",
										 "Количество, Сумма, СуммаНДС, Всего");		
	Иначе
		ТабличнаяЧастьДокумента = Документ[ИмяТабличнойЧастиДокумента];
	КонецЕсли;                 
	// ИНАГРО--
	
	Для каждого СтрокаТЧДокумента Из ТабличнаяЧастьДокумента Цикл // ИНАГРО 
		
		// ИНАГРО++
		Если  ИНАГРО_ОбщийВызовСервераПовтИсп.ЕстьБСПУ() Тогда
			Если Документ.Метаданные().Имя = "ИНАГРО_РеализацияКоммунальныхУслуг" Тогда
				Если СтрокаТЧДокумента.ДоговорКонтрагента <> СтруктураОтбора.ДоговорКонтрагента Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		// ИНАГРО--

		СтрокаТЧОбработки = Объект[ИмяТабличнойЧастиОбработки].Добавить();
		
		Для каждого Колонка Из КолокниТЧОбработки Цикл
			
			ИмяКолонки = Колонка.Имя; 
			
			Если ИмяКолонки = "Документ" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.Документ;	
				
			ИначеЕсли ИмяКолонки = "Дата" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.Дата;	
				
			ИначеЕсли ИмяКолонки = "СуществующийДокумент" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.СуществующийДокумент;	
				
			ИначеЕсли ИмяКолонки = "РасчетыВозврат" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.РасчетыВозврат;	
				
			ИначеЕсли ИмяКолонки = "ДоговорКонтрагента" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.ДоговорКонтрагента;	
				
			ИначеЕсли ИмяКолонки = "Сделка" Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтруктураОтбора.Сделка;	
				
			ИначеЕсли ИмяКолонки = "СчетУчетаНДС" Тогда
				
				Если  НЕ КолокниТЧДокумента.Найти(ИмяКолонки) = Неопределено Тогда
					
					СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонки];
					
				КонецЕсли;	
				
			ИначеЕсли ИмяКолонки = "КодУКТВЭД" Тогда
				
				// ИНАГРО++
				Если  ИНАГРО_ОбщийВызовСервераПовтИсп.ЕстьБСПУ() Тогда
					Если Документ.Метаданные().Имя = "ИНАГРО_СчетНаОплатуПокупателюБиологическихАктивов" Тогда
						Продолжить;
					КонецЕсли;
				КонецЕсли;
				// ИНАГРО-- 
				
				Если  НЕ КолокниТЧДокумента.Найти(ИмяКолонки) = Неопределено Тогда
					СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонки];
				ИначеЕсли НЕ КолокниТЧДокумента.Найти("Номенклатура") = Неопределено Тогда
					НоменклатураГТДНоменклатуры = СтрокаТЧДокумента.Номенклатура.НоменклатураГТД;	
					Если ТипЗнч(НоменклатураГТДНоменклатуры) = Тип("СправочникСсылка.НоменклатураГТД") Тогда
						СтрокаТЧОбработки.КодУКТВЭД = НоменклатураГТДНоменклатуры.КодУКТВЭД;
					ИначеЕсли ТипЗнч(НоменклатураГТДНоменклатуры) = Тип("СправочникСсылка.КлассификаторУКТВЭД") Тогда
						СтрокаТЧОбработки.КодУКТВЭД = НоменклатураГТДНоменклатуры;
					КонецЕсли; 
				КонецЕсли;	
				
			ИначеЕсли ИмяКолонки = "НомерГТД" Тогда
				
				Если  НЕ КолокниТЧДокумента.Найти("НомерГТД") = Неопределено Тогда
					
					СтрокаТЧОбработки.НомерГТД = СтрокаТЧДокумента.НомерГТД;
					
				ИначеЕсли НЕ КолокниТЧДокумента.Найти("Номенклатура") = Неопределено Тогда
					
					НоменклатураГТДНоменклатуры = СтрокаТЧДокумента.Номенклатура.НоменклатураГТД;	
					
					Если ТипЗнч(НоменклатураГТДНоменклатуры) = Тип("СправочникСсылка.НоменклатураГТД") Тогда
						СтрокаТЧОбработки.НомерГТД  = НоменклатураГТДНоменклатуры.НомерГТД;
					КонецЕсли; 
					
				КонецЕсли;
				
			// ИНАГРО++	
			ИначеЕсли ИмяКолонки = "Количество" И НЕ КолокниТЧДокумента.Найти(ИмяКолонки) = Неопределено Тогда 				
								 
				Если Объект.ДокументВводаНаОсновании <> Неопределено Тогда
					
					Если  ТипЗнч(Объект.ДокументВводаНаОсновании) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
						И Объект.ДокументВводаНаОсновании.ИНАГРО_РасхождениеКоличества Тогда 
						
						СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента.ИНАГРО_НовоеКоличество;

					ИначеЕсли (Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_РеализацияБиологическихАктивов"
						   ИЛИ Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_ВедомостьРеализация"
						   ИЛИ Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_ВедомостьРеализацияБиологическихАктивов")
						   И Объект.ДокументВводаНаОсновании.РасхождениеКоличества Тогда
						
						СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента.НовоеКоличество;
						
					Иначе
						
						СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонки];
						
					КонецЕсли;
					
				Иначе
					
					СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонки];
					
				КонецЕсли;  				
			// ИНАГРО--
			
			ИначеЕсли НЕ КолокниТЧДокумента.Найти(ИмяКолонки) = Неопределено Тогда
				
				СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонки]
				
			ИначеЕсли Прав(ИмяКолонки, 9) = "ВДокумент" Тогда
				
				// ИНАГРО++
				Если Объект.ДокументВводаНаОсновании <> Неопределено Тогда
					
					Если  ТипЗнч(Объект.ДокументВводаНаОсновании) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
						И ИмяКолонки = "КоличествоВДокумент" 
						И Объект.ДокументВводаНаОсновании.ИНАГРО_РасхождениеКоличества Тогда
						
						 ИмяКолонкиИсходногоЗначения = "ИНАГРО_НовоеКоличество";
						 
					ИначеЕсли (Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_РеализацияБиологическихАктивов"
						   ИЛИ Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_ВедомостьРеализация"
						   ИЛИ Объект.ДокументВводаНаОсновании.Метаданные().Имя = "ИНАГРО_ВедомостьРеализацияБиологическихАктивов")  
						   И ИмяКолонки = "КоличествоВДокумент"   
						   И Объект.ДокументВводаНаОсновании.РасхождениеКоличества Тогда
						   
						ИмяКолонкиИсходногоЗначения = "НовоеКоличество";						
						
					Иначе
						
						ИмяКолонкиИсходногоЗначения = Лев(ИмяКолонки, СтрДлина(ИмяКолонки) - 9);
						
					КонецЕсли;
					
				Иначе
					
					ИмяКолонкиИсходногоЗначения = Лев(ИмяКолонки, СтрДлина(ИмяКолонки) - 9); 
					
				КонецЕсли;
				// ИНАГРО--
				
				Если  НЕ КолокниТЧДокумента.Найти(ИмяКолонкиИсходногоЗначения) = Неопределено Тогда
					
					СтрокаТЧОбработки[ИмяКолонки] = СтрокаТЧДокумента[ИмяКолонкиИсходногоЗначения];
					
				ИначеЕсли ИмяКолонки = "СуммаБезСкидкиВДокумент" Тогда
					
					СтрокаТЧОбработки[ИмяКолонки] 	    = СтрокаТЧДокумента["Сумма"];
					СтрокаТЧОбработки["СуммаБезСкидки"] = СтрокаТЧДокумента["Сумма"];
					
				КонецЕсли;

			КонецЕсли;
		
		КонецЦикла; 
		
		ЗаполнитьДопПараметры(СтрокаТЧОбработки, ИмяТабличнойЧастиДокумента);
		
		Если НЕ КолокниТЧОбработки.Найти("Содержание") = Неопределено И НЕ ЗначениеЗаполнено(СтрокаТЧОбработки["Содержание"]) Тогда	
			ДанныеОбъекта = Новый Структура("Дата, Организация");
			ЗаполнитьЗначенияСвойств(ДанныеОбъекта, Документ);
			СведенияОНоменклатуре = БухгалтерскийУчетПереопределяемый.ПолучитьСведенияОНоменклатуре(СтрокаТЧДокумента.Номенклатура, ДанныеОбъекта);
			Если НЕ СведенияОНоменклатуре = Неопределено Тогда
				СтрокаТЧОбработки["Содержание"] = СведенияОНоменклатуре.НаименованиеПолное;
			КонецЕсли;
		КонецЕсли;
		
		Если    ВРЕГ(ИмяТабличнойЧастиДокумента) = "ОС"
			ИЛИ ВРЕГ(ИмяТабличнойЧастиДокумента) = "НМА" Тогда
		
			СтрокаТЧОбработки["Количество"] = 1;
			СтрокаТЧОбработки["КоличествоВДокумент"] = 1;
			СтрокаТЧОбработки["Цена"] 		= СтрокаТЧОбработки["Сумма"];
		
		КонецЕсли;
		
		Если ВРЕГ(ИмяТабличнойЧастиДокумента) = "УСЛУГИ" Тогда
			Если СтрокаТЧОбработки["Количество"] = 0 Тогда
				СтрокаТЧОбработки["Количество"] = 1;
				СтрокаТЧОбработки["КоличествоВДокумент"] = 1;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла; 
	
КонецПроцедуры

Процедура ЗаполнитьДопПараметры(СтрокаТЧ, ИмяТабличнойЧасти) 
	
	СчетаУчета = Новый Структура();
	ДопПараметры = ПолучитьДопПараметры();
	
	Для каждого ДопПараметр Из ДопПараметры Цикл
	
		СчетаУчета.Вставить(ДопПараметр.Ключ
							//, значение
							);
	КонецЦикла;

	// заполним пустые значения значениями по-умолчанию
	Для каждого ДопПараметр Из ДопПараметры Цикл
	
		Если НЕ ЗначениеЗаполнено(СтрокаТЧ[ДопПараметр.Ключ]) Тогда

			СтрокаТЧ[ДопПараметр.Ключ]  = СчетаУчета[ДопПараметр.Ключ]
					
		КонецЕсли; 
	
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьВозможныеВидыОпераций(Соответствие,  РасчетыВозврат)
	
	Соответствие.Очистить();
	
	ВидыОперацийНалоговаяНакладная = Перечисления.ВидыОперацийНалоговаяНакладная;
	ВидыОперацийПриложение2		   = Перечисления.ВидыОперацийПриложение2КНалоговойНакладной;
	
	Для каждого СтавкаНДС Из Перечисления.СтавкиНДС Цикл
		
		Если РасчетыВозврат = Перечисления.РасчетыВозврат.Расчеты Тогда
			Если СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
				ВидОперации = ВидыОперацийНалоговаяНакладная.ОсвобожденныеОперации;
			ИначеЕсли СтавкаНДС = Перечисления.СтавкиНДС.НеНДС Тогда
				ВидОперации = ВидыОперацийНалоговаяНакладная.НеНДСОперации;
			Иначе
				//0% или 20% - один вид операции
				ВидОперации = ВидыОперацийНалоговаяНакладная.ОблагаемыеОперации;
			КонецЕсли;
		Иначе
			Если СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
				ВидОперации = ВидыОперацийПриложение2.ОсвобожденныеОперацииВозврат;
			ИначеЕсли СтавкаНДС = Перечисления.СтавкиНДС.НеНДС Тогда
				ВидОперации = ВидыОперацийПриложение2.НеНДСОперацииВозврат;
			Иначе
				//0% или 20% - один вид операции
				ВидОперации = ВидыОперацийПриложение2.ОблагаемыеОперацииВозврат;
			КонецЕсли;
		КонецЕсли;	
		
		Соответствие.Вставить(СтавкаНДС, ВидОперации);
	КонецЦикла;
	
КонецФункции // ПолучитьВозможныеВидыОпераций(РасчетыВозврат, ВидДокумента)()

Функция ПолучитьИмяЭлементаПеречисленияСтавкиНДС(СтавкаНДС)

	ИндексСтавкиНДС	= Перечисления.СтавкиНДС.Индекс(СтавкаНДС);
	Возврат Метаданные.Перечисления.СтавкиНДС.ЗначенияПеречисления[ИндексСтавкиНДС].Имя;

КонецФункции // ПолучитьИмяЭлементаПеречисленияСтавкиНДС(()
 

Функция ОтобратьСтрокиТабличнойЧасти(Объект, ИмяТабличнойЧасти, СтавкаНДС=Неопределено, СтруктураОтбораДанных)
	
	НайденныеСтроки = Объект[ИмяТабличнойЧасти].НайтиСтроки(СтруктураОтбораДанных);
	
	Сч = 0;
	Пока Сч <= НайденныеСтроки.Количество()-1 Цикл
		ТекущаяСтрока = НайденныеСтроки.Получить(Сч);
	 	Если      (НЕ (СтавкаНДС=Неопределено ИЛИ ТекущаяСтрока.СтавкаНДС = СтавкаНДС) ) 
			  ИЛИ (   (ИмяТабличнойЧасти = "ОС"  ИЛИ ИмяТабличнойЧасти = "НМА") И ТекущаяСтрока.СуммаВДокумент = 0)
			  ИЛИ (НЕ (ИмяТабличнойЧасти = "ОС"  ИЛИ ИмяТабличнойЧасти = "НМА") И ТекущаяСтрока.КоличествоВДокумент = 0) Тогда
			НайденныеСтроки.Удалить(Сч);	
		Иначе
			Сч = Сч + 1;
		КонецЕсли; 
	КонецЦикла;
	
	Если НайденныеСтроки.Количество() = 0 Тогда
		МассивОтобранныхСтрок = Неопределено;
	Иначе
		МассивОтобранныхСтрок = НайденныеСтроки;
	КонецЕсли;
	
	Возврат МассивОтобранныхСтрок;
	
КонецФункции

Процедура ЗаполнитьШапкуНалоговогоДокумента(Объект, НалоговыйДокумент, ВидОперации, Данные)
	
	Если НЕ Объект.РежимПоДатам Тогда
		Если НЕ ЗначениеЗаполнено(Объект.Дата) Тогда
			ТекущаяРабочаяДата = ОбщегоНазначенияБП.ПолучитьРабочуюДату();
			
			Если НачалоДня(ТекущаяРабочаяДата) = НачалоДня(ТекущаяДата())  Тогда
				ДатаДокумента = ТекущаяДата();	
			Иначе
				ДатаДокумента = ТекущаяРабочаяДата;	
			КонецЕсли; 
		Иначе
			ДатаДокумента = Объект.Дата;	
		КонецЕсли;
	Иначе	
		// время установим на  12 часов
		ДатаДокумента = Данные.Дата + 43200;	
	КонецЕсли;
	НалоговыйДокумент.Дата = ДатаДокумента;
	
	НалоговыйДокумент.АвторасчетНДС = Ложь;
	НалоговыйДокумент.ВалютаДокумента 	= Данные.ВалютаДокумента;
	НалоговыйДокумент.ВидОперации 		= ВидОперации;
	НалоговыйДокумент.ДоговорКонтрагента= Данные.ДоговорКонтрагента;
	НалоговыйДокумент.Сделка			= ?(НЕ ЗначениеЗаполнено(Данные.Сделка), Неопределено, Данные.Сделка);
	
	Если ТипЗнч(ВидОперации) = Тип("ПеречислениеСсылка.ВидыОперацийНалоговаяНакладная") Тогда
		// НалоговаяНакладная
		Если НЕ Объект.ФормироватьИтоговыеНакладные Тогда
			НалоговыйДокумент.ДокументОснование = Данные.ДокументОснование;
		Иначе
			НалоговыйДокумент.Сводная = Истина;	
		КонецЕсли;
		
		Если не Объект.ДокументВводаНаОсновании = Неопределено Тогда
			НалоговыйДокумент.ДокументВводаНаОсновании = Объект.ДокументВводаНаОсновании;
		КонецЕсли;
		
	Иначе
		// Приложение 2
		НалоговыйДокумент.НалоговаяНакладная = Данные.ДокументОснование;
		НалоговыйДокумент.СпецРежимНалогообложения 	   = НалоговыйДокумент.НалоговаяНакладная.СпецРежимНалогообложения;
		НалоговыйДокумент.ТипПричиныНевыдачиПокупателю = НалоговыйДокумент.НалоговаяНакладная.ТипПричиныНевыдачиПокупателю;
	КонецЕсли; 
	НалоговыйДокумент.ДоговорКонтрагента = Данные.ДоговорКонтрагента;
	НалоговыйДокумент.Контрагент = Данные.ДоговорКонтрагента.Владелец;
	
	СчетаУчета   = БухгалтерскийУчетРасчетовСКонтрагентами.ПолучитьСчетаРасчетовСКонтрагентом(Объект.Организация, НалоговыйДокумент.Контрагент, НалоговыйДокумент.ДоговорКонтрагента);
	НалоговыйДокумент.СчетУчетаНДС = СчетаУчета.СчетУчетаНДСПродаж;
	
	Документы.НалоговаяНакладная.ЗаполнитьУсловиеПродажи(НалоговыйДокумент);
	Если ЗначениеЗаполнено(НалоговыйДокумент.ДоговорКонтрагента.ФормаРасчетов) Тогда
	    НалоговыйДокумент.ФормаРасчетов = НалоговыйДокумент.ДоговорКонтрагента.ФормаРасчетов;  	
		Если НалоговыйДокумент.Дата >= '2014-03-01' И НалоговыйДокумент.Дата < '2015-01-01' Тогда
			Если НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунка" Тогда
				НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунку";
			КонецЕсли;
		ИначеЕсли НалоговыйДокумент.Дата >= '2015-01-01' Тогда
			Если НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунку" Тогда
				НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунка";
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли НалоговыйДокумент.ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.Бартерный Тогда
		НалоговыйДокумент.ФормаРасчетов = "Бартер";  	
	Иначе		
		НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунку";
		Если НалоговыйУчетПовтИсп.ДатаВступленияВСилуПриказа1379() <= ДатаДокумента ИЛИ ДатаДокумента >= '2015-01-01'Тогда
			НалоговыйДокумент.ФормаРасчетов = "Оплата з поточного рахунка";
		КонецЕсли;
	КонецЕсли;
	
	НалоговыйДокумент.Ответственный = Пользователи.ТекущийПользователь();
	НалоговыйДокумент.КтоВыписалНалоговуюНакладную = БухгалтерскийУчетПереопределяемый.ПолучитьЗначениеПоУмолчанию("КтоВыписалНалоговуюНакладную");

	СтруктураКурсаВзаиморасчетов = МодульВалютногоУчета.ПолучитьКурсВалюты(НалоговыйДокумент.ДоговорКонтрагента.ВалютаВзаиморасчетов, НалоговыйДокумент.Дата);
	НалоговыйДокумент.КурсВзаиморасчетов = СтруктураКурсаВзаиморасчетов.Курс;
	НалоговыйДокумент.КратностьВзаиморасчетов = СтруктураКурсаВзаиморасчетов.Кратность;
	
	НалоговыйДокумент.Организация 	   = Объект.Организация;
	Если ТипЗнч(ВидОперации) = Тип("ПеречислениеСсылка.ВидыОперацийНалоговаяНакладная") Тогда
		НалоговыйДокумент.ОбособленноеПодразделение = Объект.ОбособленноеПодразделение;
	КонецЕсли;
	НалоговыйДокумент.СуммаВключаетНДС = Данные.СуммаВключаетНДС;
	
	НалоговыйДокумент.СчетНДС 		   = ПланыСчетов.Хозрасчетный.РасчетыПоНДС;
	
	Если ЗначениеЗаполнено(Данные.ДокументОснование) Тогда
		Если ОбщегоНазначенияБП.ЕстьРеквизитДокумента("ТипЦен", Данные.ДокументОснование.Метаданные()) Тогда
			НалоговыйДокумент.ТипЦен = Данные.ДокументОснование.ТипЦен;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(НалоговыйДокумент.ТипЦен) Тогда
	   НалоговыйДокумент.ТипЦен = Данные.ДоговорКонтрагента.ТипЦен;
	КонецЕсли;   
	
	Документы.НалоговаяНакладная.ЗаполнитьВидДоговора(НалоговыйДокумент);

	Если ТипЗнч(ВидОперации) = Тип("ПеречислениеСсылка.ВидыОперацийНалоговаяНакладная") Тогда
		Документы.НалоговаяНакладная.УстановитьТипПричиныНевыдачиПокупателюПоУмолчанию(НалоговыйДокумент);
	КонецЕсли;
	   
КонецПроцедуры

Процедура ДобавитьСтрокиВТабличнуюЧастьНалоговогоДокумента(Объект, Документ, ИмяТабличнойЧасти, СтрокиТабличнойЧастиОбработки, Данные)
	
	ИмяДокумента = Документ.Метаданные().ПолноеИмя();
	Если Данные.ДокументОснование = Неопределено Тогда
		ИмяДокументаОснования = Неопределено;
	Иначе
		ИмяДокументаОснования 	= Данные.ДокументОснование.Метаданные().ПолноеИмя();
		ДатаОтгрузкиОплаты 		= Данные.ДокументОснование.Дата;	
	КонецЕсли;
	
	КолонкиТЧОбработки 		= Метаданные.Обработки.ФормированиеНалоговыхНакладных.ТабличныеЧасти.Найти(ИмяТабличнойЧасти).Реквизиты;		
	КолонкиТЧДокумента 		= Документ.Метаданные().ТабличныеЧасти.Найти(ИмяТабличнойЧасти).Реквизиты;
	
	Для каждого СтрокаТЧОбработки Из СтрокиТабличнойЧастиОбработки Цикл
		
		СтрокаТЧДокумента = Документ[ИмяТабличнойЧасти].Добавить();
		
		Для Каждого КолонкаТЧДокумента Из КолонкиТЧДокумента Цикл
			
			ИмяКолонкиТЧДокумента = КолонкаТЧДокумента.Имя;
			
			// проверим, имеется ли колонка в ТЧ Обоработки с измененным значением 
			КолонкаВДокумент = КолонкиТЧОбработки.Найти(ИмяКолонкиТЧДокумента + "ВДокумент");
			Если НЕ КолонкаВДокумент = Неопределено Тогда
				ИмяКолонкиВДокумент = КолонкаВДокумент.Имя;
				Если ИмяДокумента = "Документ.НалоговаяНакладная" Тогда
					// колонка ТЧ обработки с названием "..ВДокумент" должна попасть в колоку докумета без этого суффикса. 
					СтрокаТЧДокумента[ИмяКолонкиТЧДокумента] = СтрокаТЧОбработки[ИмяКолонкиВДокумент];
				Иначе // Документ.Приложение2КНалоговойНакладной
					// перенесем значение 
					СтрокаТЧДокумента[ИмяКолонкиТЧДокумента] = СтрокаТЧОбработки[ИмяКолонкиТЧДокумента];	
					
					// добавим значения по корректировке
					Если ИмяКолонкиВДокумент = "КоличествоВДокумент" Тогда
						
						СтрокаТЧДокумента["ИзменениеКоличества"]= - СтрокаТЧОбработки[ИмяКолонкиВДокумент];		
						
					ИначеЕсли ИмяКолонкиВДокумент = "СуммаВДокумент" Тогда
						
						СтрокаТЧДокумента["ИзменениеСуммы"]		= - СтрокаТЧОбработки[ИмяКолонкиВДокумент];		
						
					ИначеЕсли ИмяКолонкиВДокумент = "СуммаНДСВДокумент" Тогда
						
						СтрокаТЧДокумента["ИзменениеСуммыНДС"]	= - СтрокаТЧОбработки[ИмяКолонкиВДокумент];
						
					КонецЕсли;
				КонецЕсли;
				
			Иначе 
				// перенесем колонки с одинаковыми именами
				Если НЕ КолонкиТЧОбработки.Найти(ИмяКолонкиТЧДокумента) = Неопределено Тогда
					СтрокаТЧДокумента[ИмяКолонкиТЧДокумента] = СтрокаТЧОбработки[ИмяКолонкиТЧДокумента];
				КонецЕсли;
			КонецЕсли;
			
			Если  ИмяДокумента = "Документ.НалоговаяНакладная"
				И (Врег(ИмяТабличнойЧасти) = "ОС" ИЛИ Врег(ИмяТабличнойЧасти) = "НМА") Тогда
				
				// если НН выписывается на "весь" необоротный актив, очистим реквизиты по частичной отгрузке (авансу)
				Если СтрокаТЧОбработки.КоличествоВДокумент = 1 Тогда
					СтрокаТЧДокумента.Количество = 0;
					СтрокаТЧДокумента.Цена = 0;
				КонецЕсли;
			
			КонецЕсли;
			
		КонецЦикла;
		
		// Одноименные и связанные с ними колонки перенесли. 
		// Теперь заполним специфические колонки для каждой табличной части
		Если  ИмяДокумента = "Документ.НалоговаяНакладная" Тогда
			ДанныеОбъекта = Новый Структура("Контрагент, ВидОперации, ДоговорКонтрагента, ВалютаВзаиморасчетов, НеЯвляетсяРезидентом, Дата, ТипПричиныНевыдачиПокупателю");
			ЗаполнитьЗначенияСвойств(ДанныеОбъекта, Документ);
			ДанныеОбъекта.ДоговорКонтрагента   = ДанныеОбъекта.ДоговорКонтрагента;
			ДанныеОбъекта.ВалютаВзаиморасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеОбъекта.ДоговорКонтрагента, "ВалютаВзаиморасчетов");
			ДанныеОбъекта.НеЯвляетсяРезидентом = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеОбъекта.Контрагент, "НеЯвляетсяРезидентом");
			
			Документы.НалоговаяНакладная.ЗаполнитьСтатьюДекларацииНДСНалоговыеОбязательства(ДанныеОбъекта, СтрокаТЧДокумента, ИмяТабличнойЧасти, Неопределено); 
		Иначе
			Документы.Приложение2КНалоговойНакладной.ЗаполнитьСтатьюДекларацииНДСНалоговыеОбязательства(Документ, СтрокаТЧДокумента, ИмяТабличнойЧасти); 
		КонецЕсли;
		
		Если ИмяДокумента = "Документ.НалоговаяНакладная" Тогда
			
			// Дата отгрузки (оплаты) = дата документа-основания (кроме Счета)
			Если  Объект.РежимПоДатам  Тогда
				Если НЕ КолонкиТЧДокумента.Найти("ДатаОтгрузкиОплаты") = Неопределено Тогда
					СтрокаТЧДокумента.ДатаОтгрузкиОплаты = '0001-01-01';
				КонецЕсли;
			ИначеЕсли НЕ ИмяДокументаОснования = "Документ.СчетНаОплатуПокупателю"
			   И НЕ ИмяДокументаОснования = "Документ.ЗаказПокупателя"
			   И НЕ КолонкиТЧДокумента.Найти("ДатаОтгрузкиОплаты") = Неопределено Тогда
				СтрокаТЧДокумента["ДатаОтгрузкиОплаты"] = ДатаОтгрузкиОплаты;
			КонецЕсли;
			
		Иначе// Документ.Приложение2КНалоговойНакладной
			
			Если НЕ КолонкиТЧДокумента.Найти("Причина") = Неопределено Тогда
				СтрокаТЧДокумента["Причина"] = "Повернення";
			КонецЕсли;
			
			Если НЕ КолонкиТЧДокумента.Найти("ДатаКорректировки") = Неопределено Тогда
				СтрокаТЧДокумента["ДатаКорректировки"] = СтрокаТЧОбработки["Дата"];
			КонецЕсли;
			
		КонецЕсли;			
		
	КонецЦикла;

КонецПроцедуры

Процедура ЗаполнитьПодвалНалоговогоДокумента(НалоговыйДокумент)
	
	// Заполним ЛьготуНДС в документе
	Если  ТипЗнч(НалоговыйДокумент) = Тип("ДокументОбъект.НалоговаяНакладная") Тогда
		Документы.НалоговаяНакладная.ОбновитьЗначениеЛьготыНДС(НалоговыйДокумент);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаписатьПровестиНапечататьНалоговыеДокументы(Объект, НалоговыеДокументы, МассивСозданныхОбъектов)
	
	Для каждого ЭлементСоответствия Из НалоговыеДокументы Цикл
		
		НалоговыйДокумент = ЭлементСоответствия.Значение;
		Если  НЕ (ТипЗнч(НалоговыйДокумент) = Тип("ДокументОбъект.НалоговаяНакладная")
			  ИЛИ ТипЗнч(НалоговыйДокумент) = Тип("ДокументОбъект.Приложение2КНалоговойНакладной")) Тогда
			  Продолжить;
		КонецЕсли;
		
		ЗаполнитьПодвалНалоговогоДокумента(НалоговыйДокумент);
		

		Если НЕ Объект.НеЗаписыватьДокументы = Истина Тогда
			НалоговыйДокумент.Записать(РежимЗаписиДокумента.Запись);
		КонецЕсли;
		
		Если  Объект.ПроводитьДокументы Тогда
			Попытка
				НалоговыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
			
		КонецЕсли;
		
		МассивСозданныхОбъектов.Добавить(НалоговыйДокумент);
	КонецЦикла; 
	
КонецПроцедуры

Процедура ПолучитьДанныеДляФормированияНалоговыхДокументов(Объект, ТаблицаДанных, СтруктураОтбораДанных)

	Перем ТекущийДокумент;
	
	СтруктураДанных = Новый Структура();
	
	Если НЕ СтруктураОтбораДанных.Свойство("Документ", ТекущийДокумент) Тогда 
		// не указан конкретный документ
		Возврат;
	КонецЕсли;
			
	// для каждой ставки НДС создадим свой набор строк для каждой ТЧ кроме ВозвратнойТары
	СтруктураПоСтавкеНДС = Новый Структура();
	Для каждого СтавкаНДС Из Перечисления.СтавкиНДС Цикл
		СтруктураПоСтавкеНДС = Новый Структура();
		
		ТаблицаТовары 				= ОтобратьСтрокиТабличнойЧасти(Объект, "Товары", СтавкаНДС, СтруктураОтбораДанных);
		ТаблицаУслуги 				= ОтобратьСтрокиТабличнойЧасти(Объект, "Услуги", СтавкаНДС, СтруктураОтбораДанных);
		ТаблицаОС 					= ОтобратьСтрокиТабличнойЧасти(Объект, "ОС", СтавкаНДС, СтруктураОтбораДанных);
		ТаблицаНематериальныеАктивы = ОтобратьСтрокиТабличнойЧасти(Объект, "НМА", СтавкаНДС, СтруктураОтбораДанных);
		
		Если НЕ ТаблицаТовары = Неопределено Тогда
			СтруктураПоСтавкеНДС.Вставить("Товары", ТаблицаТовары);
		КонецЕсли;
		Если НЕ ТаблицаУслуги = Неопределено Тогда
			СтруктураПоСтавкеНДС.Вставить("Услуги", ТаблицаУслуги);
		КонецЕсли;
		Если НЕ ТаблицаОС = Неопределено Тогда
			СтруктураПоСтавкеНДС.Вставить("ОС", ТаблицаОС);
		КонецЕсли;
		Если НЕ ТаблицаНематериальныеАктивы = Неопределено Тогда
			СтруктураПоСтавкеНДС.Вставить("НМА", ТаблицаНематериальныеАктивы);
		КонецЕсли;
		
		Если НЕ СтруктураПоСтавкеНДС.Количество() = 0 Тогда
			// Имеются строки с указанной ставкой НДС
			СтруктураДанных.Вставить(ПолучитьИмяЭлементаПеречисленияСтавкиНДС(СтавкаНДС), СтруктураПоСтавкеНДС);
		КонецЕсли;
		
	КонецЦикла; 
	
	// ... ВозвратнуюТару занесем отдельно: если имеются несколько ставок - тару можно отнести к любой из них.
	ТаблицаВозвратнаяТара = ОтобратьСтрокиТабличнойЧасти(Объект, "ВозвратнаяТара", , СтруктураОтбораДанных);
	Если НЕ ТаблицаВозвратнаяТара = Неопределено Тогда
		СтруктураДанных.Вставить("ВозвратнаяТара", ТаблицаВозвратнаяТара);
	КонецЕсли;
	
	Если НЕ СтруктураДанных.Количество() = 0 Тогда
		// Нужно формировать документ
		СтрокаТаблицыДанных = ТаблицаДанных.Добавить();
		СтрокаТаблицыДанных.Дата				= СтруктураОтбораДанных.Дата;
		СтрокаТаблицыДанных.ДоговорКонтрагента	= СтруктураОтбораДанных.ДоговорКонтрагента;
		СтрокаТаблицыДанных.Сделка				= СтруктураОтбораДанных.Сделка;
		СтрокаТаблицыДанных.РасчетыВозврат		= СтруктураОтбораДанных.РасчетыВозврат;
		Если ТекущийДокумент = Неопределено Тогда
			СтрокаТаблицыДанных.ВалютаДокумента  = СтруктураОтбораДанных.ДоговорКонтрагента.ВалютаВзаиморасчетов;
			СтрокаТаблицыДанных.СуммаВключаетНДС 	= Истина;
		Иначе
			СтрокаТаблицыДанных.ВалютаДокумента 	= ТекущийДокумент.ВалютаДокумента;
			СтрокаТаблицыДанных.СуммаВключаетНДС 	= ТекущийДокумент.СуммаВключаетНДС;
		КонецЕсли;	
		СтрокаТаблицыДанных.ДокументОснование 	= ТекущийДокумент;
		СтрокаТаблицыДанных.СтруктураДанных		= СтруктураДанных;
	КонецЕсли;
	
КонецПроцедуры


Процедура УдалитьСтрокиТабличныхЧастейНоменклатуры(Объект, СтруктураУдаляемыхСтрок = Неопределено) Экспорт
	УдалитьСтрокиТабличнойЧасти(Объект.Товары, 			СтруктураУдаляемыхСтрок);
	УдалитьСтрокиТабличнойЧасти(Объект.ВозвратнаяТара, 	СтруктураУдаляемыхСтрок);
	УдалитьСтрокиТабличнойЧасти(Объект.Услуги, 			СтруктураУдаляемыхСтрок);
	УдалитьСтрокиТабличнойЧасти(Объект.ОС,		 			СтруктураУдаляемыхСтрок);
	УдалитьСтрокиТабличнойЧасти(Объект.НМА, СтруктураУдаляемыхСтрок);
КонецПроцедуры

Процедура УдалитьСтрокиТабличнойЧасти(ТабличнаяЧасть, СтруктураУдаляемыхСтрок = Неопределено) Экспорт
	
	Если  СтруктураУдаляемыхСтрок = Неопределено Тогда
		
		ТабличнаяЧасть.Очистить();
		
	Иначе
		
		НайденныеСтроки = ТабличнаяЧасть.НайтиСтроки(СтруктураУдаляемыхСтрок);
		Для каждого НайденнаяСтрока  Из НайденныеСтроки Цикл
			ТабличнаяЧасть.Удалить(НайденнаяСтрока)
		КонецЦикла; 
		
	КонецЕсли;

КонецПроцедуры

Процедура ОбновитьСоставИсточниковНоменклатуры(Объект) Экспорт

	СтруктураПоиска = Новый Структура();
	
	Сч = 0;
	Пока Сч < Объект.ИсточникиНоменклатуры.Количество() Цикл
	
		СтрокаДокументов = Объект.ИсточникиНоменклатуры[Сч];
		
		СтруктураПоиска.Очистить();
		
		СтруктураПоиска.Вставить("Дата",		 	   СтрокаДокументов.Дата);
		СтруктураПоиска.Вставить("ДоговорКонтрагента", СтрокаДокументов.ДоговорКонтрагента);
		СтруктураПоиска.Вставить("Сделка", 				СтрокаДокументов.Сделка);
		СтруктураПоиска.Вставить("РасчетыВозврат", 	   СтрокаДокументов.РасчетыВозврат);
		
		// поищем соответствующие строки в договорах
		НайденныеСтроки = Объект.Договора.НайтиСтроки(СтруктураПоиска);
		
		// если строк в таблице договоров нет - удалим строку Источников номенклатуры и соответсвтующие строки табличных частей
		Если НайденныеСтроки.Количество() = 0 Тогда
			// Для удаления строк табличных частей в структуру поиска добавим ссылку на документ
			СтруктураПоиска.Вставить("Документ", СтрокаДокументов.Документ);
			
			// Удалим лишние строки Табличных Частей с номенклатурой
			УдалитьСтрокиТабличныхЧастейНоменклатуры(Объект,СтруктураПоиска);
			
			// Удалим лишние строки Источников номенклатуры
			Объект.ИсточникиНоменклатуры.Удалить(СтрокаДокументов);
		Иначе
			// добавим строки в Договора с доп. параметрами, если таких там еще нет	
			Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
				СтруктураПоиска.Вставить(ДопПараметр.Ключ, СтрокаДокументов[ДопПараметр.Ключ]);
			КонецЦикла;			
			СтруктураПоиска.Вставить("ЗаТару",СтрокаДокументов.ЗаТару);
			СтруктураПоиска.Вставить("СтавкаНДС",СтрокаДокументов.СтавкаНДС);			
			
			НайденныеСтроки = Объект.Договора.НайтиСтроки(СтруктураПоиска);
			Если НайденныеСтроки.Количество() = 0 Тогда
				СтрокаДоговоров = Объект.Договора.Добавить();
				Для каждого Параметр Из СтруктураПоиска Цикл
					СтрокаДоговоров[Параметр.Ключ] = Параметр.Значение;
				КонецЦикла;
			КонецЕсли;
			
			Сч = Сч + 1;
			
		КонецЕсли;	
		
	КонецЦикла; 

КонецПроцедуры

Процедура ОбновитьИсточникиНоменклатуры(Объект, СтруктураОтбораНоменклатуры) Экспорт

	ИтоговаяТаблица = ПолучитьСтруктуруИтоговойТаблицы();
	
	ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбораНоменклатуры, ИтоговаяТаблица, "Товары");
	ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбораНоменклатуры, ИтоговаяТаблица, "Услуги");
	ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбораНоменклатуры, ИтоговаяТаблица, "ВозвратнаяТара");
	ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбораНоменклатуры, ИтоговаяТаблица, "ОС");
	ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбораНоменклатуры, ИтоговаяТаблица, "НМА");
	
	ВалютаВзаиморасчетовНУ  = СтруктураОтбораНоменклатуры.ДоговорКонтрагента.ВалютаВзаиморасчетов;
	
	// получим реквизиты документа, связанные с НДС
	Документ = СтруктураОтбораНоменклатуры.Документ;
	Если Документ = Неопределено Тогда
		// Без документа- основания
		ВалютаДокумента  = ВалютаВзаиморасчетовНУ;
		СуммаВключаетНДС = Истина;
	
	Иначе
		
		ВалютаДокумента  = Документ.ВалютаДокумента;
		СуммаВключаетНДС = Документ.СуммаВключаетНДС;
	
	КонецЕсли; 
	
	// пересчитаем суммы с учетом ошибок округления и реквизитов учета НДС в документе в гривны
	ПогрешностиОкругления 	  = Новый Соответствие();
	ПогрешностиОкругленияТара = Новый Соответствие();
	
	ДанныеВалДок  		= МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаДокумента, Объект.Дата);
	ДанныеВалВзаимНУ 	= МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаВзаиморасчетовНУ, Объект.Дата);
	
	Для каждого СтрокаТаблицы Из ИтоговаяТаблица Цикл
		
		// Рассчитаем суммы в документе в валюте документа
		СуммаСНДСВал    = СтрокаТаблицы.СуммаВДокумент + ?(СуммаВключаетНДС, 0, СтрокаТаблицы.СуммаНДСВДокумент);
		СуммаНДСВал     = СтрокаТаблицы.СуммаНДСВДокумент;
		
		// Рассчитаем суммы в документе в валюте регл. учета
		Если ВалютаДокумента = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета() Тогда
			СтрокаТаблицы.СуммаВДокумент 	 = СуммаСНДСВал;
			СтрокаТаблицы.СуммаНДСВДокумент  = СуммаНДСВал;
		Иначе
			                             	
			СтрокаТаблицы.СуммаВДокумент 	= МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(СуммаСНДСВал, 
																		ВалютаДокумента,
																		ВалютаВзаиморасчетовНУ, 
																		ДанныеВалДок.Курс, 
																		ДанныеВалВзаимНУ.Курс,
																		ДанныеВалДок.Кратность,
																		ДанныеВалВзаимНУ.Кратность,
																		, ?(СтрокаТаблицы.ЗаТару, ПогрешностиОкругленияТара, ПогрешностиОкругления) , "СуммаСНДСРегл");
			
			СтрокаТаблицы.СуммаНДСВДокумент  = УчетНДСКлиентСервер.РассчитатьСуммуНДСсУчетомПогрешности(СтрокаТаблицы.СуммаВДокумент,
																					Истина,
																					Истина,
																					СтрокаТаблицы.СтавкаНДС,
																					?(СтрокаТаблицы.ЗаТару, ПогрешностиОкругленияТара, ПогрешностиОкругления));
		КонецЕсли;
		
	КонецЦикла;	
	
	КолонкиГруппировок = "СтавкаНДС,ЗаТару";
	Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
		КолонкиГруппировок = КолонкиГруппировок +"," + ДопПараметр.Ключ;
	КонецЦикла;
	ИтоговаяТаблица.Свернуть(КолонкиГруппировок,"СуммаВДокумент, СуммаНДСВДокумент");
	
	// создадим новые строки в ИсточникахНоменклатуры, взамен старых
	СтарыеСтрокиИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.НайтиСтроки(СтруктураОтбораНоменклатуры);
	
	// Данные о документе установим установим в таблице в "старом" порядке
	МинПозиция = Неопределено;
	Для каждого СтрокаИсточниковНоменклатуры Из СтарыеСтрокиИсточниковНоменклатуры Цикл
		Позиция = Объект.ИсточникиНоменклатуры.Индекс(СтрокаИсточниковНоменклатуры);
		Если  МинПозиция = Неопределено 
		  ИЛИ Позиция < МинПозиция Тогда
			 МинПозиция = Позиция;
		КонецЕсли;
		
		Объект.ИсточникиНоменклатуры.Удалить(СтрокаИсточниковНоменклатуры);
	КонецЦикла; 
	
	Если МинПозиция = Неопределено Тогда
		МинПозиция = 0;
	КонецЕсли;
	
	Если ИтоговаяТаблица.Количество() = 0 Тогда
		// добавим единственную "пустую" строку
		СтрокаИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.Вставить(МинПозиция);
		СтрокаИсточниковНоменклатуры.СуществующийДокумент	= СтруктураОтбораНоменклатуры.СуществующийДокумент;
		СтрокаИсточниковНоменклатуры.Дата				 	= СтруктураОтбораНоменклатуры.Дата;
		СтрокаИсточниковНоменклатуры.ДоговорКонтрагента 	= СтруктураОтбораНоменклатуры.ДоговорКонтрагента;
		СтрокаИсточниковНоменклатуры.Сделка				 	= СтруктураОтбораНоменклатуры.Сделка;
		СтрокаИсточниковНоменклатуры.Документ 				= СтруктураОтбораНоменклатуры.Документ;
		СтрокаИсточниковНоменклатуры.РасчетыВозврат 		= СтруктураОтбораНоменклатуры.РасчетыВозврат;
	Иначе
		
		СтруктураОтбораДоговоров = Новый Структура();
		СтруктураОтбораДоговоров.Вставить("Дата", 				СтруктураОтбораНоменклатуры.Дата);
		СтруктураОтбораДоговоров.Вставить("ДоговорКонтрагента", СтруктураОтбораНоменклатуры.ДоговорКонтрагента);
		СтруктураОтбораДоговоров.Вставить("Сделка", 			СтруктураОтбораНоменклатуры.Сделка);
		СтруктураОтбораДоговоров.Вставить("РасчетыВозврат",		СтруктураОтбораНоменклатуры.РасчетыВозврат);

		
		Для каждого СтрокаСумм Из ИтоговаяТаблица Цикл
			
			СтрокаИсточниковНоменклатуры = Объект.ИсточникиНоменклатуры.Вставить(МинПозиция);
			СтрокаИсточниковНоменклатуры.СуществующийДокумент	= СтруктураОтбораНоменклатуры.СуществующийДокумент;
			СтрокаИсточниковНоменклатуры.Дата				    = СтруктураОтбораНоменклатуры.Дата;
			СтрокаИсточниковНоменклатуры.ДоговорКонтрагента 	= СтруктураОтбораНоменклатуры.ДоговорКонтрагента;
			СтрокаИсточниковНоменклатуры.Сделка 				= СтруктураОтбораНоменклатуры.Сделка;
			СтрокаИсточниковНоменклатуры.Документ 				= СтруктураОтбораНоменклатуры.Документ;
			СтрокаИсточниковНоменклатуры.РасчетыВозврат	 		= СтруктураОтбораНоменклатуры.РасчетыВозврат;
			Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
				СтрокаИсточниковНоменклатуры[ДопПараметр.Ключ]  = СтрокаСумм[ДопПараметр.Ключ];
			КонецЦикла; 
			СтрокаИсточниковНоменклатуры.ЗаТару    	  	   		= СтрокаСумм.ЗаТару;
			СтрокаИсточниковНоменклатуры.СтавкаНДС      		= СтрокаСумм.СтавкаНДС;
			СтрокаИсточниковНоменклатуры.СуммаНДС       		= СтрокаСумм.СуммаНДСВДокумент;
			СтрокаИсточниковНоменклатуры.Сумма		  			= СтрокаСумм.СуммаВДокумент;
			
			//Добавим строки в Договора по тем видам деятельности/счетам, по которым есть строки в документах	
			Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
				СтруктураОтбораДоговоров.Вставить(ДопПараметр.Ключ, СтрокаСумм[ДопПараметр.Ключ]);
			КонецЦикла; 
			СтруктураОтбораДоговоров.Вставить("ЗаТару", 	СтрокаСумм.ЗаТару);
			СтруктураОтбораДоговоров.Вставить("СтавкаНДС",  СтрокаСумм.СтавкаНДС);
			
			СтрокиДоговоров = Объект.Договора.НайтиСтроки(СтруктураОтбораДоговоров);
			Если СтрокиДоговоров.Количество() = 0 Тогда
				СтрокаДоговоров = Объект.Договора.Добавить();
				Для каждого Параметр Из СтруктураОтбораДоговоров Цикл
					СтрокаДоговоров[Параметр.Ключ] = Параметр.Значение;
				КонецЦикла; 
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыгрузитьТабличнуюЧастьВИтоговуюТаблицу(Объект, СтруктураОтбора, Таблица, ИмяТабличнойЧасти)
	
	КолонкиТабличнойЧасти = Метаданные.Обработки.ФормированиеНалоговыхНакладных.ТабличныеЧасти.Найти(ИмяТабличнойЧасти).Реквизиты;
	
	// выгружаем строки табличных частей документов в таблицу
	СтрокиПоДокументу = Объект[ИмяТабличнойЧасти].НайтиСтроки(СтруктураОтбора);
	Для каждого СтрокаТЧ Из СтрокиПоДокументу Цикл
		
		СтрокаИтоговойТаблицы = Таблица.Добавить();
		
		СтрокаИтоговойТаблицы.СуммаВДокумент = СтрокаТЧ.СуммаВДокумент;
		
		Если  КолонкиТабличнойЧасти.Найти("СтавкаНДС") = Неопределено 
		  ИЛИ НЕ ЗначениеЗаполнено(СтрокаТЧ.СтавкаНДС) Тогда
		  // если ставка в документе не заполнена считаем это ставкой НеНДС.
		  СтрокаИтоговойТаблицы.СтавкаНДС = Перечисления.СтавкиНДС.НеНДС;
		Иначе 
			СтрокаИтоговойТаблицы.СтавкаНДС = СтрокаТЧ.СтавкаНДС;
		КонецЕсли;
		
		Если  НЕ КолонкиТабличнойЧасти.Найти("СуммаНДСВДокумент") = Неопределено Тогда
			СтрокаИтоговойТаблицы.СуммаНДСВДокумент = СтрокаТЧ.СуммаНДСВДокумент;
		КонецЕсли; 
		
		Если ИмяТабличнойЧасти = "ВозвратнаяТара" Тогда
		  	СтрокаИтоговойТаблицы.ЗаТару = Истина;
		КонецЕсли;
		
		Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
			
			СтрокаИтоговойТаблицы[ДопПараметр.Ключ] = СтрокаТЧ[ДопПараметр.Ключ];
		
		КонецЦикла; 
	
	КонецЦикла; 

КонецПроцедуры

Функция ПолучитьСтруктуруИтоговойТаблицы() Экспорт
	
	ИтоговаяТаблица = Новый ТаблицаЗначений();
	Для каждого ДопПараметр Из ПолучитьДопПараметры() Цикл
		ИтоговаяТаблица.Колонки.Добавить(ДопПараметр.Ключ, ДопПараметр.Значение);	
	КонецЦикла;
	ИтоговаяТаблица.Колонки.Добавить("СтавкаНДС", 		Новый ОписаниеТипов("ПеречислениеСсылка.СтавкиНДС"));
	ИтоговаяТаблица.Колонки.Добавить("ЗаТару", 		Новый ОписаниеТипов("Булево"));
	ИтоговаяТаблица.Колонки.Добавить("СуммаВДокумент", ОбщегоНазначенияБПКлиентСервер.ПолучитьОписаниеТиповЧисла(15,2));
	ИтоговаяТаблица.Колонки.Добавить("СуммаНДСВДокумент", ОбщегоНазначенияБПКлиентСервер.ПолучитьОписаниеТиповЧисла(15,2));

	Возврат ИтоговаяТаблица;

КонецФункции // ()

Функция ПолучитьДопПараметры() Экспорт

	// ВНД, СчетНДС 
	ДопПараметры = Новый Структура;
	//ДопПараметры.Вставить("СчетУчетаНДС", Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	
	Возврат ДопПараметры;
	
КонецФункции // ()

Функция ПолучитьПреставленияДопПараметров() Экспорт

	ПреставленияДопПараметров = Новый Структура;
	//ПреставленияДопПараметров.Вставить("СчетУчетаНДС", "Счет НДС н/о");
	
	Возврат ПреставленияДопПараметров;
	
КонецФункции // ()

Функция ПолучитьДопустимыеТипыДокументов() Экспорт
	
	ДопустимыеТипыДокументов = Новый Массив;
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.РеализацияТоваровУслуг"));	
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.СчетНаОплатуПокупателю"));	
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.НалоговаяНакладная"));	
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ОтчетКомиссионераОПродажах"));	
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ОтчетКомитентуОПродажах"));	
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг"));
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.РеализацияУслугПоПереработке"));
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ПередачаОС"));
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ПередачаНМА"));
	
	// ИНАГРО++
	ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ИНАГРО_ВедомостьРеализация"));
	Если ИНАГРО_ОбщийВызовСервераПовтИсп.ЕстьБСПУ() Тогда	
		ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ИНАГРО_РеализацияБиологическихАктивов"));
		ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ИНАГРО_ВедомостьРеализацияБиологическихАктивов"));
		ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ИНАГРО_РеализацияКоммунальныхУслуг"));
		ДопустимыеТипыДокументов.Добавить(Тип("ДокументСсылка.ИНАГРО_СчетНаОплатуПокупателюБиологическихАктивов"));
	КонецЕсли; 
	// ИНАГРО--

	Возврат ДопустимыеТипыДокументов;

КонецФункции // ()

#КонецЕсли